<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <meta name="theme-color" content="#140b22">
  <title>Calendar Game</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{--bg1:#0b0714;--bg2:#140b22}
    body{background:linear-gradient(180deg,var(--bg1),var(--bg2));min-height:100svh}
    .card{background:rgba(26,15,43,.86);border:1px solid rgba(120,53,175,.45)}
    .panel{background:rgba(88,28,135,.25);border:1px solid rgba(120,53,175,.45)}
    .btn{border:1px solid rgba(120,53,175,.5);background:rgba(120,53,175,.22)}
    .btn:hover{background:rgba(120,53,175,.35)}
    .dimmed{opacity:.45;filter:saturate(.6)}
    .bar{height:6px;border-radius:6px;overflow:hidden;background:rgba(120,53,175,.25);border:1px solid rgba(120,53,175,.45)}
    .bar>span{display:block;height:100%;background:linear-gradient(90deg,#a855f7,#7c3aed)}
    .flipable{transition:transform 450ms ease-in-out;transform-origin:50% 50%}
  </style>
</head>
<body class="text-purple-50">
  <div id="app" class="px-3 py-4">Loading…</div>

  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel" data-presets="react" data-plugins="proposal-class-properties,proposal-object-rest-spread,proposal-nullish-coalescing-operator,proposal-optional-chaining">
    const {useEffect,useMemo,useRef,useState} = React;

    const MONTH=["January","February","March","April","May","June","July","August","September","October","November","December"];
    const DAY=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];
    const toAstro=y=>y>0?y:1-Math.abs(y);
    const isLeap=y=>{y=toAstro(y);return (y%400===0)||((y%4===0)&&(y%100!==0));};
    const dim=(y,m)=>m===2?(isLeap(y)?29:28):([4,6,9,11].includes(m)?30:31);
    function jdn(y,m,d){const a=Math.floor((14-m)/12),y2=y+4800-a,m2=m+12*a-3;return d+Math.floor((153*m2+2)/5)+365*y2+Math.floor(y2/4)-Math.floor(y2/100)+Math.floor(y2/400)-32045;}
    const wd=(y,m,d)=> (jdn(toAstro(y),m,d)+1)%7;
    const fmtYear=y=>y>0?String(y):`${Math.abs(y)} BC`;
    const fmt=(y,m,d)=>`${MONTH[m-1]} ${d}, ${fmtYear(y)}`;
    const rint=(a,b)=>Math.floor(Math.random()*(b-a+1))+a;

    function randomDate(minY,maxY){
      for(;;){
        const y=rint(minY,maxY); if(y===0) continue;
        const m=rint(1,12), d=rint(1,dim(y,m));
        return {y,m,d};
      }
    }

    function useIsDesktop(){
      const [d,setD]=useState(false);
      useEffect(()=>{
        const upd=()=>setD((navigator.maxTouchPoints||0)===0);
        upd(); window.addEventListener('resize',upd); return ()=>window.removeEventListener('resize',upd);
      },[]);
      return d;
    }

    function makeStats(){ return {correct:0,total:0,streak:0,longest:0,avgSum:0,avgCount:0,lastStart:0}; }

    function App(){
      const isDesktop=useIsDesktop();
      const MODES=["classic","blitz","sudden","flash","deduction","lookup"];
      const [mode,setMode]=useState("classic");
      const [stats,setStats]=useState(()=>{const o={}; MODES.forEach(m=>o[m]=makeStats()); return o;});
      const [disableStats,setDisableStats]=useState(false);
      const [disableAve,setDisableAve]=useState(true); // "Disable ave time" default enabled
      const [prevDisableAve,setPrevDisableAve]=useState(true);
      const [flip,setFlip]=useState(false);
      const [ad,setAd]=useState(true);
      const [rangeAD,setRangeAD]=useState({min:1600,max:2100});
      const [rangeBC,setRangeBC]=useState({min:-500,max:-1});
      const activeRange = ad?rangeAD:rangeBC;
      const setActiveRange= ad?setRangeAD:setRangeBC;

      const [cur,setCur]=useState(()=>randomDate(activeRange.min,activeRange.max));
      const [reveal,setReveal]=useState(false);
      const [feedback,setFeedback]=useState(null);
      const [input,setInput]=useState("");

      // timers
      const [blitzLeft,setBlitzLeft]=useState(30), blitzRef=useRef(null), [blitzRun,setBlitzRun]=useState(false);
      const [suddenLeft,setSuddenLeft]=useState(5), suddenRef=useRef(null), [suddenRun,setSuddenRun]=useState(false);
      const [flashLeft,setFlashLeft]=useState(1.2), flashRef=useRef(null), [flashState,setFlashState]=useState("idle");

      const curWd = useMemo(()=>wd(cur.y,cur.m,cur.d),[cur]);
      const stat = stats[mode];

      // avg reset rule
      useEffect(()=>{
        if(prevDisableAve && !disableAve){
          setStats(s=>{const n={...s}; n[mode]={...n[mode],avgSum:0,avgCount:0}; return n;});
        }
        setPrevDisableAve(disableAve);
      },[disableAve]);

      useEffect(()=>{ // reset per-mode UI
        setReveal(false); setFeedback(null); setInput("");
        stopAll();
        if(mode==="blitz") setBlitzLeft(30);
        if(mode==="sudden") setSuddenLeft(5);
        if(mode==="flash"){ setFlashLeft(1.2); setFlashState("idle"); }
      },[mode]);

      function stopAll(){ if(blitzRef.current){clearInterval(blitzRef.current);blitzRef.current=null;} setBlitzRun(false);
                          if(suddenRef.current){clearInterval(suddenRef.current);suddenRef.current=null;} setSuddenRun(false);
                          if(flashRef.current){clearInterval(flashRef.current);flashRef.current=null;} }

      function nextDate(){
        const r=randomDate(activeRange.min,activeRange.max);
        setCur(r); setReveal(false); setFeedback(null); setInput("");
        if(!disableAve) markStart();
      }
      useEffect(()=>{ nextDate(); },[]);

      function markStart(){
        setStats(s=>{const n={...s}; n[mode]={...n[mode], lastStart:performance.now()}; return n;});
      }
      function record(ok){
        if(mode==="lookup") return;
        setStats(s=>{
          const m={...s[mode]};
          m.total += 1;
          if(ok){ m.correct += 1; m.streak += 1; m.longest = Math.max(m.longest,m.streak);
                  if(!disableAve && m.lastStart){ const dt=(performance.now()-m.lastStart)/1000; m.avgSum+=dt; m.avgCount+=1; }
          } else { m.streak = 0; }
          return {...s,[mode]:m};
        });
      }
      const avgTime = stat.avgCount>0 ? (stat.avgSum/stat.avgCount) : 0;

      // desktop input parser
      function parseInput(t){
        t=t.trim().toLowerCase();
        if(/^[0-6]$/.test(t)) return Number(t);
        const map={"sunday":0,"sun":0,"su":0,"monday":1,"mon":1,"mo":1,"tuesday":2,"tue":2,"tu":2,"wednesday":3,"wed":3,"we":3,"thursday":4,"thu":4,"th":4,"friday":5,"fri":5,"fr":5,"saturday":6,"sat":6,"sa":6};
        return map[t] ?? null;
      }

      function answer(idx){
        const ok = idx===curWd;
        record(ok);
        setFeedback(ok?"good":"bad");
        setReveal(true);
      }

      // timers
      useEffect(()=>{
        if(mode!=="blitz") return;
        if(!blitzRun){ if(blitzRef.current){clearInterval(blitzRef.current);blitzRef.current=null;} return; }
        blitzRef.current=setInterval(()=>{ setBlitzLeft(x=>{
          if(x<=0.05){ clearInterval(blitzRef.current);blitzRef.current=null; setBlitzRun(false); return 0; }
          return +(x-0.05).toFixed(2);
        });},50);
        return ()=>{ if(blitzRef.current){clearInterval(blitzRef.current);blitzRef.current=null;} };
      },[blitzRun,mode]);

      useEffect(()=>{
        if(mode!=="sudden") return;
        if(!suddenRun){ if(suddenRef.current){clearInterval(suddenRef.current);suddenRef.current=null;} return; }
        suddenRef.current=setInterval(()=>{ setSuddenLeft(x=>{
          if(x<=0.05){ clearInterval(suddenRef.current); suddenRef.current=null; setSuddenRun(false); setReveal(true); record(false); return 0; }
          return +(x-0.05).toFixed(2);
        });},50);
        return ()=>{ if(suddenRef.current){clearInterval(suddenRef.current);suddenRef.current=null;} };
      },[suddenRun,mode]);

      useEffect(()=>{
        if(mode!=="flash") return;
        if(flashState!=="running"){ if(flashRef.current){clearInterval(flashRef.current);flashRef.current=null;} return; }
        flashRef.current=setInterval(()=>{ setFlashLeft(x=>{
          if(x<=0.05){ clearInterval(flashRef.current); flashRef.current=null; setFlashState("hidden"); return 0; }
          return +(x-0.05).toFixed(2);
        });},50);
        return ()=>{ if(flashRef.current){clearInterval(flashRef.current);flashRef.current=null;} };
      },[flashState,mode]);

      function Bar({value,max}){
        const pct=Math.max(0,Math.min(100,100*value/max));
        return <div className="bar"><span style={{width:pct+'%'}}/></div>
      }

      // mobile-fit sizing: reduce top/bottom spacing and font sizes on small screens
      const dateCls = "text-3xl font-semibold sm:text-4xl";

      return (
        <div className="max-w-3xl mx-auto">
          {/* Tabs */}
          <div className="flex items-center justify-between">
            <h1 className="text-xl sm:text-2xl font-semibold">Calendar Game</h1>
            <div className="flex flex-wrap gap-2">
              {["classic","blitz","sudden","flash","deduction","lookup"].map(t=>
                <button key={t} onClick={()=>setMode(t)} className={"px-3 py-1 rounded-full panel "+(mode===t?"ring-2 ring-purple-400":"")}>
                  {t[0].toUpperCase()+t.slice(1)}
                </button>
              )}
            </div>
          </div>

          <div className="card rounded-3xl p-4 mt-4">
            {/* Mode bars */}
            {mode==="blitz" && (<div className="mb-2"><div className="flex justify-between text-xs mb-1"><span>Session</span><span>{blitzLeft.toFixed(2)}s</span></div><Bar value={blitzLeft} max={30}/></div>)}
            {mode==="sudden" && (<div className="mb-2"><div className="flex justify-between text-xs mb-1"><span>Per‑question</span><span>{suddenLeft.toFixed(2)}s</span></div><Bar value={suddenLeft} max={5}/></div>)}
            {mode==="flash" && (<div className="mb-2"><div className="flex justify-between text-xs mb-1"><span>Flash</span><span>{flashLeft.toFixed(2)}s</span></div><Bar value={flashLeft} max={1.2}/></div>)}

            {mode!=="lookup" && (
              <div className="text-center">
                <div id="dateText" className={"flipable "+dateCls} style={flip?{transform:'rotate(180deg)'}:undefined}>
                  {mode==="flash" ? (flashState==="hidden" ? "…" : (flashState==="running" ? fmt(cur.y,cur.m,cur.d) : "—")) : fmt(cur.y,cur.m,cur.d)}
                </div>
                {reveal && <div className="mt-1 text-sm">Answer: <span className="font-semibold">{DAY[curWd]}</span></div>}
              </div>
            )}

            {/* Controls */}
            {mode!=="lookup" && (
              <div className="mt-3 flex flex-wrap justify-center gap-2">
                <button className="btn rounded-xl px-4 py-2" onClick={()=>nextDate()}>New</button>
                <button className="btn rounded-xl px-4 py-2" onClick={()=>{
                  if(mode==="flash"){ setFlashState("idle"); setFlashLeft(1.2); }
                  setReveal(true);
                }}>Reveal</button>
                {mode==="blitz" && (<><button className="btn rounded-xl px-6 py-2 font-semibold" onClick={()=>{ setBlitzRun(s=>!s); if(!disableAve) markStart(); }}>{blitzRun?"Stop":"Begin"}</button><button className="btn rounded-xl px-4 py-2" onClick={()=>{ setBlitzRun(false); setBlitzLeft(30); }}>Reset</button></>)}
                {mode==="sudden" && (<><button className="btn rounded-xl px-6 py-2 font-semibold" onClick={()=>{ setSuddenRun(true); setSuddenLeft(5); nextDate(); }}>{ "Begin" }</button><button className="btn rounded-xl px-4 py-2" onClick={()=>{ setSuddenRun(false); setSuddenLeft(5); }}>Reset</button></>)}
                {mode==="flash" && (<><button className="btn rounded-xl px-6 py-2 font-semibold" onClick={()=>{ setFlashState("running"); setFlashLeft(1.2); if(!disableAve) markStart(); }}>Begin</button><button className="btn rounded-xl px-4 py-2" onClick={()=>{ setFlashState("idle"); setFlashLeft(1.2); }}>Reset</button></>)}
              </div>
            )}

            {/* Day options */}
            {mode!=="lookup" && (
              <div className="mt-3 grid grid-cols-2 sm:grid-cols-3 gap-2">
                {DAY.map((d,i)=>(
                  <button key={i} className={"btn rounded-xl py-2 "+(reveal && i===curWd?"ring-2 ring-green-400":"")} onClick={()=>answer(i)}>{d}</button>
                ))}
              </div>
            )}

            {/* Desktop input */}
            {isDesktop && mode!=="lookup" && (
              <div className="mt-2 flex items-center gap-2">
                <input value={input} onChange={e=>setInput(e.target.value)} onKeyDown={e=>{ if(e.key==="Enter"){ const idx=parseInput(input); if(idx!=null) { answer(idx); setInput(""); } } }}
                  className="flex-1 bg-transparent border border-purple-700/40 rounded px-3 py-2"
                  placeholder="Type 0–6 or Sunday…Saturday, then Enter"/>
                <button className="btn rounded px-3 py-2" onClick={()=>{ const idx=parseInput(input); if(idx!=null){ answer(idx); setInput(""); }}}>Submit</button>
              </div>
            )}

            {/* Stats */}
            {mode!=="lookup" && (
              <div className="mt-3 grid grid-cols-3 gap-2">
                <div className={"panel rounded-xl p-3 "+(disableStats?"dimmed":"")}>
                  <div className="text-xs text-purple-200/80">Score</div>
                  <div className="text-2xl font-semibold">{stat.correct} / {stat.total}</div>
                </div>
                <div className={"panel rounded-xl p-3 "+(disableStats?"dimmed":"")}>
                  <div className="text-xs text-purple-200/80">Streak / Longest</div>
                  <div className="text-2xl font-semibold">{stat.streak} / {stat.longest}</div>
                </div>
                <div className={"panel rounded-xl p-3 "+(disableAve?"dimmed":"")}>
                  <div className="text-xs text-purple-200/80">Average Time</div>
                  <div className="text-2xl font-semibold">{stat.avgCount>0 ? (stat.avgSum/stat.avgCount).toFixed(2)+' s' : '—'}</div>
                </div>
              </div>
            )}

            {/* Toggles + Ranges (compact to fit mobile) */}
            {mode!=="lookup" && (
              <div className="mt-3 grid grid-cols-1 sm:grid-cols-3 gap-2">
                <label className={"panel rounded-xl p-3 flex items-center justify-between cursor-pointer "+(disableStats?"ring-2 ring-red-500/60":"")}>
                  <span>Disable stats</span>
                  <input type="checkbox" className="accent-fuchsia-400 h-5 w-5" checked={disableStats} onChange={e=>setDisableStats(e.target.checked)}/>
                </label>
                <label className={"panel rounded-xl p-3 flex items-center justify-between cursor-pointer "+(disableAve?"ring-2 ring-red-500/60":"")}>
                  <span>Disable ave time</span>
                  <input type="checkbox" className="accent-fuchsia-400 h-5 w-5" checked={disableAve} onChange={e=>setDisableAve(e.target.checked)}/>
                </label>
                <label className="panel rounded-xl p-3 flex items-center justify-between cursor-pointer">
                  <span>Flip date</span>
                  <input type="checkbox" className="accent-fuchsia-400 h-5 w-5" checked={flip}
                    onChange={e=>{
                      if(e.target.checked){ setFlip(true); }
                      else{
                        const el=document.getElementById('dateText');
                        if(el){ el.style.transform='rotate(360deg)'; setTimeout(()=>{ el.style.transform=''; },460); }
                        setFlip(false);
                      }
                    }}/>
                </label>
              </div>
            )}

            {/* Year range compact */}
            {mode!=="lookup" && (
              <div className="mt-3 grid grid-cols-2 gap-2">
                <div className="panel rounded-xl p-2">
                  <div className="text-xs text-purple-200/80">Min Year</div>
                  <input type="number" className="mt-1 w-full bg-transparent border border-purple-700/40 rounded px-2 py-1"
                    value={activeRange.min} onChange={e=>setActiveRange(r=>({...r,min:Math.max(-10000,Math.min(10000,Number(e.target.value)||0))}))}/>
                </div>
                <div className="panel rounded-xl p-2">
                  <div className="text-xs text-purple-200/80">Max Year</div>
                  <input type="number" className="mt-1 w-full bg-transparent border border-purple-700/40 rounded px-2 py-1"
                    value={activeRange.max} onChange={e=>setActiveRange(r=>({...r,max:Math.max(-10000,Math.min(10000,Number(e.target.value)||0))}))}/>
                </div>
                <div className="panel rounded-xl p-2 col-span-2 flex items-center justify-center gap-2">
                  <span className="text-sm">Era</span>
                  <button className={"btn rounded px-3 py-1 "+(ad?"ring-2 ring-purple-400":"")} onClick={()=>setAd(true)}>AD</button>
                  <button className={"btn rounded px-3 py-1 "+(!ad?"ring-2 ring-purple-400":"")} onClick={()=>setAd(false)}>BC</button>
                </div>
              </div>
            )}

            {/* Lookup */}
            {mode==="lookup" && (
              <div className="grid sm:grid-cols-2 gap-3">
                <div className="panel rounded-2xl p-4">
                  <div className="text-sm text-purple-200/90 mb-2">Lookup</div>
                  <div className="grid grid-cols-3 gap-2">
                    <div><div className="text-xs">Year</div><input type="number" className="w-full bg-transparent border border-purple-700/40 rounded px-2 py-2" id="y"/></div>
                    <div><div className="text-xs">Month</div><input type="number" className="w-full bg-transparent border border-purple-700/40 rounded px-2 py-2" id="m"/></div>
                    <div><div className="text-xs">Day</div><input type="number" className="w-full bg-transparent border border-purple-700/40 rounded px-2 py-2" id="d"/></div>
                  </div>
                  <div className="mt-3 flex gap-2">
                    <button className="btn rounded px-3 py-2" onClick={()=>{
                      const y=Number(document.getElementById('y').value||0);
                      const m=Number(document.getElementById('m').value||0);
                      const d=Number(document.getElementById('d').value||0);
                      if(y===0){ alert("Year 0 doesn't exist"); return; }
                      if(m<1||m>12){ alert("Invalid month"); return; }
                      if(d<1||d>dim(y,m)){ alert("Invalid day"); return; }
                      alert(DAY[wd(y,m,d)]);
                    }}>Compute</button>
                  </div>
                </div>
                <div className="panel rounded-2xl p-4">
                  <div className="text-sm text-purple-200/90 mb-2">Notes</div>
                  <p className="text-sm text-purple-100/90">Proleptic Gregorian calendar; astronomical year mapping internally (1 BC → 0). Year 0 isn’t valid in input.</p>
                </div>
              </div>
            )}
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("app")).render(<App/>);
  </script>
</body>
</html>
