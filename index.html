<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <meta name="theme-color" content="#140b22">
  <title>Calendar Game</title>
  <meta name="application-name" content="Calendar Game">
  <meta name="apple-mobile-web-app-title" content="Calendar Game">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{--bg1:#0b0714;--bg2:#140b22}
    body{background:linear-gradient(180deg,var(--bg1),var(--bg2))}
    body.lookup-bg{background: url('./mandelbrot-purple.png') center/cover no-repeat fixed}
    .card{background:rgba(26,15,43,.85);border:1px solid rgba(120,53,175,.45)}
    .panel{background:rgba(88,28,135,.25);border:1px solid rgba(120,53,175,.45)}
    button,input,select{-webkit-tap-highlight-color:transparent}

    @keyframes flashPulse{0%{box-shadow:0 0 0 0 var(--ring);background:var(--bg0)}
      35%{box-shadow:0 0 0 10px var(--ring);background:var(--bg1)}
      100%{box-shadow:0 0 0 0 transparent;background:var(--bg0)}}
    .flash-good{--ring:rgba(16,185,129,.5);--bg0:rgba(16,185,129,.10);--bg1:rgba(16,185,129,.25);animation:flashPulse .45s ease-in-out}
    .flash-bad{--ring:rgba(239,68,68,.5);--bg0:rgba(239,68,68,.10);--bg1:rgba(239,68,68,.25);animation:flashPulse .45s ease-in-out}

    .flipable{transition:transform 450ms ease-in-out;transform-origin:50% 50%}
    .no-anim{transition:none!important}

    .bar{height:6px;border-radius:6px;overflow:hidden;background:rgba(120,53,175,.25);border:1px solid rgba(120,53,175,.45)}
    .bar>span{display:block;height:100%;background:linear-gradient(90deg,#a855f7,#7c3aed)}

    .stat-title{font-size:12px;color:rgba(221,214,254,.85)}
    .stat-big,.stat-slashed{font-size:22px;line-height:1.1;font-weight:600}
    .stat-dim{opacity:.6}

    .btn{border:1px solid rgba(120,53,175,.5);background:rgba(88,28,135,.35);padding:.55rem .9rem;border-radius:14px;transition:all .15s;box-shadow:0 1px 0 rgba(0,0,0,.25)}
    .btn:hover{background:rgba(88,28,135,.55)}
    .btn-primary{padding:.65rem 1.2rem;border-radius:14px;background:#7c3aed;color:#fff;border-color:#7c3aed}
    .btn-reset{background:#e11d48;border-color:#e11d48;color:#fff}
    .btn-wide{padding-left:1.35rem;padding-right:1.35rem}

    .chip{background:rgba(120,53,175,.25);border:1px solid rgba(120,53,175,.45);padding:.25rem .5rem;border-radius:.75rem;font-size:12px}
  </style>
</head>
<body class="text-purple-50">
  <div id="root" class="min-h-screen w-full">Loading…</div>
  <pre id="errors" style="display:none;white-space:pre-wrap;background:#2b0f3a;border:1px solid #7e22ce;color:#fca5a5;padding:.75rem;border-radius:.75rem;margin:1rem;max-width:64rem"></pre>
  <script>
    addEventListener('error',e=>{const x=document.getElementById('errors');x.style.display='block';x.textContent='⚠️ '+(e.error?.message||e.message)});
    addEventListener('unhandledrejection',e=>{const x=document.getElementById('errors');x.style.display='block';x.textContent='⚠️ '+(e.reason?.message||String(e.reason))});
  </script>

  <!-- React & Babel (pinned versions + CORS) -->
  <script src="https://unpkg.com/react@18.2.0/umd/react.production.min.js" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.production.min.js" crossorigin="anonymous"></script>
  <script src="https://unpkg.com/@babel/standalone@7.25.0/babel.min.js" crossorigin="anonymous"></script>

  <!-- Fallback to jsDelivr if unpkg fails/blocked -->
  <script>
  (function(){
    function inject(src){var s=document.createElement('script');s.src=src;s.crossOrigin='anonymous';document.head.appendChild(s);}
    setTimeout(function(){
      if(!window.React){inject('https://cdn.jsdelivr.net/npm/react@18.2.0/umd/react.production.min.js');}
      if(!window.ReactDOM){inject('https://cdn.jsdelivr.net/npm/react-dom@18.2.0/umd/react-dom.production.min.js');}
      if(!window.Babel){inject('https://cdn.jsdelivr.net/npm/@babel/standalone@7.25.0/babel.min.js');}
    },1200);
  })();
  </script>

  <script type="text/babel" data-presets="env,react">
    const {useEffect,useMemo,useRef,useState} = React;

    /* ===== Calendar helpers ===== */
    const MONTH=["January","February","March","April","May","June","July","August","September","October","November","December"];
    const DAY=["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];
    const toAstro = y => y>0?y:1-Math.abs(y);
    const isLeap = y => { y=toAstro(y); return y%400===0 || (y%4===0 && y%100!==0); };
    const dim = (y,m)=> m===2 ? (isLeap(y)?29:28) : [4,6,9,11].includes(m)?30:31;
    function jdnGregorian(y,m,d){ const a=Math.floor((14-m)/12),y2=y+4800-a,m2=m-3+12*a; return d+Math.floor((153*m2+2)/5)+365*y2+Math.floor(y2/4)-Math.floor(y2/100)+Math.floor(y2/400)-32045; }
    const wday=(y,m,d)=> (jdnGregorian(toAstro(y),m,d)+1)%7;
    const fmtYear = y => y>0?String(y):`${Math.abs(y)} BC`;
    const fmt=(y,m,d)=> `${MONTH[m-1]} ${d}, ${fmtYear(y)}`;
    const rint=(a,b)=>Math.floor(Math.random()*(b-a+1))+a;
    function randomDate(minY,maxY){ for(;;){ let y=rint(minY,maxY); if(y===0) continue; let m=rint(1,12), d=rint(1,dim(y,m)); if(d<=dim(y,m)) return {y,m,d}; } }

    const isTouch=typeof window!=="undefined" && ("ontouchstart" in window || navigator.maxTouchPoints>0 || matchMedia("(pointer:coarse)").matches);
    const isTimer = m => m==="blitz"||m==="sudden"||m==="flash";

    function App(){
      const [mode,setMode]=useState("classic");
      useEffect(()=>{ document.body.classList.toggle("lookup-bg", mode==="lookup"); },[mode]);

      const [includeBC,setIncludeBC]=useState(false);
      const [adRange,setAdRange]=useState({min:1,max:10000});
      const [bcRange,setBcRange]=useState({min:-10000,max:10000});
      const [minY,setMinY]=useState(1), [maxY,setMaxY]=useState(10000);

      const [date,setDate]=useState(()=>randomDate(1,10000));
      const [stack,setStack]=useState([]);

      const correct=useMemo(()=>wday(date.y,date.m,date.d),[date]);
      const [guesses,setGuesses]=useState([]); const [status,setStatus]=useState(null);
      const [msg,setMsg]=useState("");

      /* ===== per-mode stats ===== */
      const emptyStat={played:0,good:0,streak:0,best:0,timeSum:0,timeCnt:0};
      const makeAll=()=>({classic:{...emptyStat},blitz:{...emptyStat},sudden:{...emptyStat},flash:{...emptyStat},deduction:{...emptyStat}});
      const [stats,setStats]=useState(makeAll);
      const [statsOff,setStatsOff]=useState({classic:false,blitz:false,sudden:false,flash:false,deduction:false});
      const cur = stats[mode] || emptyStat;
      const off = statsOff[mode]??true;

      const [trackClassic,setTrackClassic]=useState(false);
      const [trackDed,setTrackDed]=useState(false);
      const trackOn = ()=> isTimer(mode) || (mode==="classic"&&trackClassic) || (mode==="deduction"&&trackDed);

      const tStartRef=useRef(null);
      const [flashFx,setFlashFx]=useState(null);
      function pulse(type,idx,after=()=>{}){ setFlashFx({type,idx}); setTimeout(()=>{ setFlashFx(null); after(); },450); }

      const [flip,setFlip]=useState(false); const [rot,setRot]=useState(0);
      function toggleFlip(ch){ if(mode==="classic"||mode==="deduction"){ setRot(r=>r+180); } setFlip(ch); }

      /* timers */
      const [blitzSec,setBlitzSec]=useState(60), [blitzRemain,setBlitzRemain]=useState(60), [blitzRunning,setBlitzRunning]=useState(false);
      const blitzStartRef=useRef(null), blitzPausedAtRef=useRef(null), blitzPausedAccRef=useRef(0);

      const [qSec,setQSec]=useState(7), [qRemain,setQRemain]=useState(7);
      const qDeadlineRef=useRef(null), qPausedAtRef=useRef(null), qPausedAccRef=useRef(0);

      const [flashMs,setFlashMs]=useState(1200), [flashRemain,setFlashRemain]=useState(0);
      const [phase,setPhase]=useState('dash');
      const flashTimerRef=useRef(null), flashStartRef=useRef(null);

      const [active,setActive]=useState(false);
      const inputRef=useRef(null), [input,setInput]=useState("");

      useEffect(()=>{ if(!isTouch) inputRef.current?.focus(); else document.activeElement?.blur(); },[date,mode,active]);

      useEffect(()=>{
        const onVis=()=>{
          const now=performance.now();
          if(document.hidden){
            if(blitzRunning && blitzPausedAtRef.current==null) blitzPausedAtRef.current=now;
            if(qDeadlineRef.current && qPausedAtRef.current==null) qPausedAtRef.current=now;
          }else{
            if(blitzPausedAtRef.current!=null){ blitzPausedAccRef.current += now - blitzPausedAtRef.current; blitzPausedAtRef.current=null; }
            if(qPausedAtRef.current!=null){ qPausedAccRef.current += now - qPausedAtRef.current; qPausedAtRef.current=null; }
          }
        };
        document.addEventListener("visibilitychange", onVis);
        return ()=>document.removeEventListener("visibilitychange", onVis);
      },[blitzRunning]);

      useEffect(()=>{
        let raf;
        const loop=()=>{
          const now=performance.now();
          if(blitzRunning && blitzStartRef.current){
            const t=(now - blitzStartRef.current - blitzPausedAccRef.current)/1000;
            const r=Math.max(0, blitzSec - t);
            setBlitzRemain(r);
            if(r<=.001){ setBlitzRunning(false); setActive(false); setMsg("Time!"); }
          }
          if(mode==="sudden" && qDeadlineRef.current){
            const r=Math.max(0, (qDeadlineRef.current + qPausedAccRef.current - now)/1000);
            setQRemain(r);
            if(r<=.001){
              qDeadlineRef.current=null;
              if(!off){ setStats(s=>{const t={...s[mode]}; t.played++; t.streak=0; return {...s,[mode]:t};}); }
              setStatus('incorrect'); setMsg(`Time! Answer: ${DAY[wday(date.y,date.m,date.d)]}. Game over.`); setActive(false);
            }
          }
          if(mode==="flash" && active && phase==='show' && flashStartRef.current){
            const r=Math.max(0,(flashMs - (now-flashStartRef.current))/1000);
            setFlashRemain(r);
          }
          raf=requestAnimationFrame(loop);
        };
        raf=requestAnimationFrame(loop);
        return ()=>cancelAnimationFrame(raf);
      },[mode,blitzSec,flashMs,off,date]);

      const resetStats=()=> setStats(s=>({...s,[mode]?:s[mode], [mode]:{played:0,good:0,streak:0,best:0,timeSum:0,timeCnt:0}}));
      const toggleStatsOff=(on)=>{ if(mode==="lookup") return; setStatsOff(o=>({...o,[mode]:on})); setStats(s=>({...s,[mode]:{...emptyStat}})); };

      const arm=()=>{ setActive(false); setMsg(""); setGuesses([]); setStatus(null); setFlashFx(null);
        setPhase('dash'); clearTimeout(flashTimerRef.current); flashStartRef.current=null; setFlashRemain(flashMs/1000);
        setBlitzRemain(blitzSec); blitzStartRef.current=null; blitzPausedAtRef.current=null; blitzPausedAccRef.current=0; setBlitzRunning(false);
        qDeadlineRef.current=null; qPausedAtRef.current=null; qPausedAccRef.current=0; setQRemain(qSec);
        tStartRef.current=null;
      };

      function pushAndNext(){
        setStack(s=>[...s,{...date}]);
        setDate(randomDate(minY,maxY));
        setGuesses([]); setStatus(null);
      }

      const addCorrectTime=()=>{
        if(tStartRef.current && trackOn() && !off){
          const dt=(performance.now()-tStartRef.current)/1000;
          setStats(s=>{ const t={...s[mode]}; t.timeSum += dt; t.timeCnt += 1; return {...s,[mode]:t};});
        }
      };
      const markRight=()=>{
        if(!off){
          setStats(s=>{ const t={...s[mode]}; t.played++; t.good++; t.streak++; if(t.streak>t.best) t.best=t.streak; return {...s,[mode]:t}; });
        }
      };
      const markWrong=()=>{
        if(!off){
          setStats(s=>{ const t={...s[mode]}; t.played++; t.streak=0; return {...s,[mode]:t}; });
        }
      };

      const begin=()=>{
        setActive(true); setMsg("");
        if(mode==="blitz"){ blitzStartRef.current=performance.now(); blitzPausedAccRef.current=0; blitzPausedAtRef.current=null; setBlitzRunning(true); setBlitzRemain(blitzSec); }
        if(mode==="sudden"){ const now=performance.now(); qDeadlineRef.current=now + qSec*1000; qPausedAccRef.current=0; qPausedAtRef.current=null; setQRemain(qSec); }
        if(mode==="flash"){ setPhase('show'); flashStartRef.current=performance.now(); clearTimeout(flashTimerRef.current);
          flashTimerRef.current=setTimeout(()=>{ setPhase('hide'); }, Math.max(50,flashMs)); setFlashRemain(flashMs/1000);
        }
        tStartRef.current=performance.now();
        pushAndNext();
      };

      function submitDoW(idx){
        if(isTimer(mode) && !active){ setMsg("Press Begin to start."); return; }
        const corr=wday(date.y,date.m,date.d);
        if(idx===corr){
          addCorrectTime(); markRight(); setStatus('correct'); pulse('good',idx,()=>pushAndNext());
          if(mode==="sudden"){ const now=performance.now(); qDeadlineRef.current=now + qSec*1000; qPausedAccRef.current=0; qPausedAtRef.current=null; setQRemain(qSec); }
        }else{
          markWrong(); setStatus('incorrect'); setGuesses(g=>g.includes(DAY[idx])?g:[...g,DAY[idx]]);
          if(mode==="sudden"){ setMsg(`Answer: ${DAY[corr]}. Game over.`); setActive(false); }
          pulse('bad',idx);
        }
      }

      const doNew=()=>{ if(isTimer(mode) && !active){ setMsg("Press Begin to start."); return; } setMsg("New."); setStatus(null); setGuesses([]); pushAndNext(); };
      function reveal(){
        if(mode==="flash"){ markWrong(); setStatus('incorrect'); setMsg(`Answer: ${DAY[wday(date.y,date.m,date.d)]}.`); arm(); return; }
        markWrong(); setStatus('incorrect'); setMsg(`Answer: ${DAY[wday(date.y,date.m,date.d)]}.`);
      }
      function goBack(){
        const prev = stack[stack.length-1]; if(!prev){ setMsg("Nothing to go back to."); return; }
        setStack(s=>s.slice(0,-1)); setDate(prev);
        setMsg(`Answer: ${DAY[wday(prev.y,prev.m,prev.d)]}.`); setStatus(null); setGuesses([]);
      }

      useEffect(()=>{ arm(); setGuesses([]); setStatus(null); setStack([]); setMsg(""); },[mode]);

      function toggleBC(ch){
        setIncludeBC(ch);
        if(ch){ setMinY(bcRange.min); setMaxY(bcRange.max); setDate(randomDate(bcRange.min,bcRange.max)); }
        else{ const mn=Math.max(1,adRange.min); setMinY(mn); setMaxY(adRange.max); setDate(randomDate(mn,adRange.max)); }
      }
      function setMinActive(v){ if(includeBC){ if(v===0) v=-1; setBcRange(r=>({...r,min:Math.min(v,maxY)})); setMinY(Math.min(v,maxY)); } else { v=Math.max(1,Math.min(v,maxY)); setAdRange(r=>({...r,min:v})); setMinY(v); } }
      function setMaxActive(v){ if(includeBC){ if(v===0) v=1; setBcRange(r=>({...r,max:Math.max(v,minY)})); setMaxY(Math.max(v,minY)); } else { v=Math.max(v,minY,1); setAdRange(r=>({...r,max:v})); setMaxY(v); } }

      const showDash = isTimer(mode) && !active;
      const showDots = (mode==="flash" && active && phase==='hide');
      const headline = showDash ? "—" : showDots ? "…" : fmt(date.y,date.m,date.d);
      const wantAnim = (!showDash && !showDots) && (mode==="classic"||mode==="deduction");
      const wantStaticFlip = (!showDash && !showDots) && !(mode==="classic"||mode==="deduction") && flip;

      /* Lookup page */
      const [lookupIn,setLookupIn]=useState(""); const [lookupOut,setLookupOut]=useState("");
      function runLookup(){
        const s=lookupIn.trim();
        const m = /^(\d{1,2})\/(\d{1,2})\/(-?\d{1,5})$/.exec(s);
        if(!m){ setLookupOut("Enter month/day/year like 7/4/1776. Years −10000…10000 (no year 0)."); return; }
        let mm=+m[1], dd=+m[2], yy=+m[3];
        if(yy===0){ setLookupOut("There is no year 0. Use −1 for 1 BC."); return; }
        if(yy<-10000 || yy>10000){ setLookupOut("Year must be between −10000 and 10000."); return; }
        if(mm<1||mm>12){ setLookupOut("Month must be 1–12."); return; }
        const maxd=dim(yy,mm);
        if(dd<1||dd>maxd){ setLookupOut(`Day must be 1–${maxd} for ${MONTH[mm-1]}.`); return; }
        const d=DAY[wday(yy,mm,dd)];
        setLookupOut(`${MONTH[mm-1]} ${dd}, ${fmtYear(yy)} is a ${d}.`);
      }
      function clearLookup(){ setLookupIn(""); if(document.activeElement) document.activeElement.blur(); }

      /* deduction (year window) */
      const [dedWin,setDedWin]=useState(100);
      const [dedInput,setDedInput]=useState("");
      function submitDeduction(e){
        e?.preventDefault();
        if(isTimer(mode) && !active){ setMsg("Press Begin to start."); return; }
        if(!dedInput) return;
        const guess = parseInt(dedInput,10);
        const ans = date.y;
        if(guess===ans){ if(tStartRef.current){const dt=(performance.now()-tStartRef.current)/1000; if((mode==="deduction"&&trackDed)&&!off){ setStats(s=>{const t={...s[mode]}; t.timeSum+=dt; t.timeCnt++; return {...s,[mode]:t};}); } } markRight(); setStatus('correct'); setMsg("Correct"); setDedInput(""); pushAndNext(); }
        else{ markWrong(); setStatus('incorrect'); setMsg(`Answer: ${fmtYear(ans)}`); }
      }

      const baseBtn="w-full rounded-2xl border px-4 py-3 text-base md:text-sm transition shadow-sm select-none";
      const idleBtn="border-purple-800/60 bg-purple-900/30 hover:bg-purple-900/60";

      const scoreStr = `${cur.good}/${cur.played}`;
      const accStr   = `${cur.played?(cur.good/cur.played*100).toFixed(1):"0.0"}%`;
      const avgStr   = (!off && (isTimer(mode)||(mode==="classic"&&trackClassic)||(mode==="deduction"&&trackDed)))
                        ? (cur.timeCnt?`${(cur.timeSum/cur.timeCnt).toFixed(2)}s`:"—") : "—";

      return (
        <div className="mx-auto px-4 py-5 w-full max-w-[480px] md:max-w-3xl lg:max-w-4xl">
          <div className="flex items-center justify-between gap-4">
            <h1 className="text-xl md:text-2xl font-semibold leading-none">Calendar Game</h1>
            <div className="flex items-center gap-3">
              <select value={mode} onChange={e=>setMode(e.target.value)}
                      className="panel rounded-xl px-2.5 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-purple-400">
                <option value="classic">Classic</option>
                <option value="blitz">Blitz</option>
                <option value="sudden">Sudden Death</option>
                <option value="flash">Flash</option>
                <option value="deduction">Deduction</option>
                <option value="lookup">Lookup</option>
              </select>
              {mode!=="lookup" && (
                <label className="flex items-center gap-2 text-sm">
                  <input type="checkbox" className="sr-only" checked={includeBC} onChange={e=>toggleBC(e.target.checked)} />
                  <span className={`w-10 h-6 rounded-full relative ${includeBC?"bg-purple-500":"bg-zinc-600"}`}>
                    <span className={`absolute top-0.5 left-0.5 w-5 h-5 rounded-full bg-white transition-transform ${includeBC?"translate-x-4":""}`}></span>
                  </span>
                  <span>BC</span>
                </label>
              )}
            </div>
          </div>

          {mode!=="lookup" && (
            <>
              <div className="mt-4 grid grid-cols-2 md:grid-cols-5 gap-3 items-stretch">
                <div className={`px-3 py-2 rounded-xl panel text-center ${off?'stat-dim':''}`}>
                  <div className="stat-title">Score</div>
                  <div className="stat-big tabular-nums">{scoreStr}</div>
                </div>
                <div className={`px-3 py-2 rounded-xl panel text-center ${off?'stat-dim':''}`}>
                  <div className="stat-title">Accuracy</div>
                  <div className="stat-big">{accStr}</div>
                </div>
                <div className={`px-3 py-2 rounded-xl panel text-center ${off?'stat-dim':''}`}>
                  <div className="stat-title">Streak / Longest</div>
                  <div className="stat-slashed"><span className="tabular-nums">{cur.streak}</span><span className="mx-1 opacity-70">/</span><span className="tabular-nums">{cur.best}</span></div>
                </div>
                <div className={`px-3 py-2 rounded-xl panel text-center ${off?'stat-dim':''} ${!(!off && (isTimer(mode)||(mode==="classic"&&trackClassic)||(mode==="deduction"&&trackDed)))?'opacity-60':''}`}>
                  <div className="stat-title">Avg time (correct)</div>
                  <div className="stat-big">{avgStr}</div>
                </div>
                <div className="px-3 py-2 flex items-center justify-center">
                  <button className="px-4 py-2 rounded-xl bg-purple-700 hover:bg-purple-600 text-sm" onClick={resetStats}>Reset stats</button>
                </div>
              </div>

              <div className="mt-3 flex flex-wrap items-center gap-4">
                <label className="flex items-center gap-2 text-sm">
                  <input type="checkbox" className="sr-only" checked={flip} onChange={e=>toggleFlip(e.target.checked)} />
                  <span className={`w-10 h-6 rounded-full relative ${flip?"bg-purple-500":"bg-zinc-600"}`}>
                    <span className={`absolute top-0.5 left-0.5 w-5 h-5 rounded-full bg-white transition-transform ${flip?"translate-x-4":""}`}></span>
                  </span>
                  <span>Flip date</span>
                </label>

                {mode==="blitz" && (
                  <div className="flex items-center gap-2">
                    <span className="text-xs text-purple-300/80">Duration</span>
                    <input type="range" min="15" max="180" step="5" value={blitzSec}
                           onChange={e=>{setBlitzSec(+e.target.value); if(!active) setBlitzRemain(+e.target.value);}}
                           className="accent-purple-500"/>
                    <span className="tabular-nums text-xs w-10 text-right">{blitzSec}s</span>
                  </div>
                )}
                {mode==="sudden" && (
                  <div className="flex items-center gap-2">
                    <span className="text-xs text-purple-300/80">Per Q</span>
                    <input type="range" min="3" max="20" step="1" value={qSec}
                           onChange={e=>{setQSec(+e.target.value); if(!active) setQRemain(+e.target.value);}}
                           className="accent-purple-500"/>
                    <span className="tabular-nums text-xs w-10 text-right">{qSec}s</span>
                  </div>
                )}
                {mode==="classic" && (
                  <label className="flex items-center gap-2 text-sm">
                    <input type="checkbox" className="sr-only" checked={trackClassic} onChange={e=>setTrackClassic(e.target.checked)} />
                    <span className={`w-10 h-6 rounded-full relative ${trackClassic?"bg-purple-500":"bg-zinc-600"}`}>
                      <span className={`absolute top-0.5 left-0.5 w-5 h-5 rounded-full bg-white transition-transform ${trackClassic?"translate-x-4":""}`}></span>
                    </span>
                    <span>Track avg</span>
                  </label>
                )}

                <div className="ml-auto flex items-center gap-3">
                  <label className="flex items-center gap-2 text-sm">
                    <input type="checkbox" className="sr-only" checked={off} onChange={e=>toggleStatsOff(e.target.checked)} />
                    <span className={`w-10 h-6 rounded-full relative ${off?"bg-rose-500/70":"bg-zinc-600"}`}>
                      <span className={`absolute top-0.5 left-0.5 w-5 h-5 rounded-full bg-white transition-transform ${off?"translate-x-4":""}`}></span>
                    </span>
                    <span>Disable stats</span>
                  </label>
                </div>
              </div>

              <details className="mt-3 rounded-2xl card p-3">
                <summary className="cursor-pointer text-sm text-purple-200/90">Year range <span className="tabular-nums ml-1">{minY} → {maxY}</span></summary>
                <div className="mt-3 space-y-3">
                  <div className="flex items-center gap-3">
                    <input type="range" min={includeBC?-10000:1} max="10000" step="1" value={minY} onChange={e=>setMinActive(+e.target.value)} className="w-full accent-purple-500"/>
                    <input type="range" min={includeBC?-10000:1} max="10000" step="1" value={maxY} onChange={e=>setMaxActive(+e.target.value)} className="w-full accent-purple-500"/>
                  </div>
                  <div className="grid grid-cols-2 gap-3 max-w-xl">
                    <input type="number" className="panel rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-400" value={minY} onChange={e=>setMinActive(+e.target.value)}/>
                    <input type="number" className="panel rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-400" value={maxY} onChange={e=>setMaxActive(+e.target.value)}/>
                  </div>
                  <p className="text-xs text-purple-300/70">Proleptic Gregorian calendar. Year 0 isn’t shown (1 BC ↔ year 0 internally). AD and BC remember their own ranges.</p>
                </div>
              </details>
            </>
          )}

          <div className="mt-5 p-5 rounded-3xl card">
            {mode==="blitz" && (
              <div className="mb-3">
                <div className="flex items-center justify-between text-xs text-purple-200/80 mb-1"><div>Blitz</div><div className="tabular-nums">{Math.floor(blitzRemain).toString().padStart(2,'0')}s</div></div>
                <div className="bar"><span style={{width:`${Math.max(0,Math.min(100,(blitzRemain/blitzSec)*100))}%`}}></span></div>
              </div>
            )}
            {mode==="sudden" && active && qDeadlineRef.current && (
              <div className="mb-3">
                <div className="flex items-center justify-between text-xs text-purple-200/80 mb-1"><div>Per-question</div><div className="tabular-nums">{qRemain.toFixed(1)}s</div></div>
                <div className="bar"><span style={{width:`${Math.max(0,Math.min(100,(qRemain/qSec)*100))}%`}}></span></div>
              </div>
            )}
            {mode==="flash" && active && phase==='show' && (
              <div className="mb-3">
                <div className="flex items-center justify-between text-xs text-purple-200/80 mb-1"><div>Flash</div><div className="tabular-nums">{flashRemain.toFixed(2)}s</div></div>
                <div className="bar"><span style={{width:`${Math.max(0,Math.min(100,(flashRemain/(flashMs/1000))*100))}%`}}></span></div>
              </div>
            )}

            <div className="text-center">
              <div className="text-xs uppercase tracking-widest text-purple-100/80">
                {mode==="lookup" ? "Lookup" : mode==="deduction" ? "What year is this?" : "What day is this?"}
              </div>
              <div className={`mt-1 text-3xl md:text-4xl font-bold ${wantAnim?'flipable':''} ${(!wantAnim&&wantStaticFlip)?'rotate-180 no-anim':''}`}
                   style={wantAnim?{transform:`rotate(${rot%360}deg)`}:undefined}>
                {(isTimer(mode) && !active) ? "—" : (mode==="flash" && active && phase==='hide') ? "…" : fmt(date.y,date.m,date.d)}
              </div>
            </div>

            {["classic","blitz","sudden","flash"].includes(mode) && (
              <>
                <div className={`mt-4 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-7 gap-3 ${(!active && isTimer(mode))?'opacity-60 pointer-events-none':''}`}>
                  {DAY.map((n,i)=>(
                    <button key={n} onClick={(e)=>{ e.currentTarget.blur(); submitDoW(i); setInput(""); if(isTouch) document.activeElement?.blur(); }}
                            className={`${baseBtn} ${flashFx && flashFx.idx===i ? (flashFx.type==='good'?'flash-good':'flash-bad')+' border-transparent' : idleBtn}`}>{n}</button>
                  ))}
                </div>

                <div className="mt-4 rounded-2xl panel px-3 py-3">
                  <div className="flex flex-wrap items-center justify-center gap-2">
                    {isTimer(mode)
                      ? <button className={`btn btn-primary btn-wide ${active?'btn-reset':''}`} onClick={active?arm:begin}>{active?'Reset':'Begin'}</button>
                      : <button className="btn btn-primary btn-wide" onClick={doNew}>New</button>
                    }
                    {!isTimer(mode) && <button className="btn" onClick={doNew}>New</button>}
                    <button className="btn" onClick={reveal}>Reveal</button>
                    <button className="btn" onClick={goBack}>Back</button>
                  </div>

                  <form onSubmit={(e)=>{e.preventDefault();submitDoW(Number(input));setInput(""); if(!isTouch) inputRef.current?.focus();}}
                        className="mt-3 items-stretch gap-2 hidden sm:flex justify-center">
                    <input ref={inputRef} value={input} onChange={e=>setInput(e.target.value)}
                          placeholder="Type 0–6 or day name. Commands: new, stop."
                          className="panel rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-400 flex-1 min-w-0 max-w-lg"/>
                    <button className="btn btn-primary">Submit</button>
                  </form>

                  {(msg || guesses.length>0) && (
                    <div className="mt-3 text-purple-100/90 text-sm text-center">
                      {msg && <div>{msg}</div>}
                      {guesses.length>0 && (<div className="mt-2 flex flex-wrap gap-1 items-center justify-center"><span className="text-purple-300/80 text-xs mr-1">Guesses so far:</span>{guesses.map(g=><span key={g} className="chip">{g}</span>)}</div>)}
                    </div>
                  )}
                </div>
              </>
            )}

            {mode==="deduction" && (
              <>
                <div className="mt-4 text-center text-sm text-purple-200/90">
                  Guess the exact year in the range <span className="tabular-nums">{date.y-dedWin}</span> → <span className="tabular-nums">{date.y+dedWin}</span>. (Use negative for BC; no year 0.)
                </div>

                <form onSubmit={submitDeduction} className="mt-3 flex items-stretch gap-2 justify-center">
                  <input value={dedInput} onChange={e=>setDedInput(e.target.value)}
                         placeholder="Enter year (e.g., 1977)" className="panel rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-400 min-w-0 w-full max-w-[420px]"/>
                  <button className="btn btn-primary">Submit</button>
                  <button type="button" className="btn" onClick={()=>{setDedInput(""); pushAndNext();}}>New</button>
                </form>

                <div className="mt-3 rounded-2xl panel px-3 py-3">
                  <div className="flex flex-wrap items-center justify-center gap-2">
                    <button className="btn" onClick={reveal}>Reveal</button>
                    <button className="btn" onClick={goBack}>Back</button>
                    <label className="flex items-center gap-2 text-sm ml-3">
                      <input type="checkbox" className="sr-only" checked={trackDed} onChange={e=>setTrackDed(e.target.checked)} />
                      <span className={`w-10 h-6 rounded-full relative ${trackDed?"bg-purple-500":"bg-zinc-600"}`}>
                        <span className={`absolute top-0.5 left-0.5 w-5 h-5 rounded-full bg-white transition-transform ${trackDed?"translate-x-4":""}`}></span>
                      </span>
                      <span>Track avg</span>
                    </label>
                  </div>
                </div>
              </>
            )}

            {mode==="lookup" && (
              <div className="mt-1 bg-black/35 p-4 rounded-2xl">
                <div className="text-sm text-purple-100/90 mb-2">
                  Provide a date in <b>month/day/year</b> format (e.g., <b>7/4/1776</b>). Years allowed <b>−10000…10000</b> (no year 0).
                </div>
                <div className="flex items-stretch gap-2">
                  <input value={lookupIn} onChange={e=>setLookupIn(e.target.value)} placeholder="7/4/1776"
                         className="panel rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-400 flex-1 min-w-0"/>
                  <button onClick={runLookup} className="btn btn-primary">Lookup</button>
                  <button onClick={clearLookup} className="btn">Clear</button>
                </div>
                {lookupOut && <div className="mt-3 text-sm">{lookupOut}</div>}
              </div>
            )}
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
  </script>
</body>
</html>
