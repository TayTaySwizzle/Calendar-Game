<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#140b22">
  <title>Calendar Game</title>
  <meta name="application-name" content="Calendar Game">
  <meta name="apple-mobile-web-app-title" content="Calendar Game">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background: linear-gradient(180deg,#0b0714,#140b22); }
    .card { background: rgba(26,15,43,.85); border: 1px solid rgba(120,53,175,.45); }
    .panel { background: rgba(88,28,135,.25); border: 1px solid rgba(120,53,175,.45); }
  </style>
</head>
<body class="text-purple-50">
  <div id="root" class="min-h-screen w-full">Loading…</div>
  <pre id="errors" style="display:none;white-space:pre-wrap;background:#2b0f3a;border:1px solid #7e22ce;color:#fca5a5;padding:.75rem;border-radius:.75rem;margin:1rem;max-width:480px;"></pre>

  <!-- React + Babel -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel" data-presets="env,react">
    const { useEffect, useMemo, useRef, useState } = React;

    /* --- Calendar helpers --- */
    const MONTH=["January","February","March","April","May","June","July","August","September","October","November","December"];
    const DAY  =["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];
    const toAstro = y => y>0 ? y : 1-Math.abs(y);
    const isLeap  = y => (y%400===0)||((y%4===0)&&(y%100!==0));
    const daysInMonthDisplay = (y,m)=> (m===2 ? (isLeap(toAstro(y))?29:28) : [4,6,9,11].includes(m)?30:31);
    function jdnGregorian(y,m,d){ const a=Math.floor((14-m)/12), y2=y+4800-a, m2=m+12*a-3;
      return d+Math.floor((153*m2+2)/5)+365*y2+Math.floor(y2/4)-Math.floor(y2/100)+Math.floor(y2/400)-32045; }
    const wday=(y,m,d)=> (jdnGregorian(toAstro(y),m,d)+1)%7;
    const fmt=(y,m,d)=> `${MONTH[m-1]} ${d} ${y>0?y:Math.abs(y)+' BC'}`;
    const rint=(a,b)=>Math.floor(Math.random()*(b-a+1))+a;
    function randomDate(minY,maxY){ let y; do{ y=rint(minY,maxY);}while(y===0);
      const m=rint(1,12), d=rint(1,daysInMonthDisplay(y,m)); return {y,m,d}; }
    const ALIAS={sun:0,sunday:0,mon:1,monday:1,tue:2,tues:2,tuesday:2,wed:3,weds:3,wednesday:3,thu:4,thur:4,thurs:4,thursday:4,fri:5,friday:5,sat:6,saturday:6};
    function parseAns(s){ const t=s.trim(), low=t.toLowerCase();
      if(!t) return {kind:"invalid"}; if(low==="help") return {kind:"cmd",payload:"help"};
      if(low==="stop") return {kind:"cmd",payload:"stop"}; if(/^\d$/.test(t)){const n=+t; return n>=0&&n<=6?{kind:"ok",payload:n}:{kind:"invalid"};}
      if(low in ALIAS) return {kind:"ok",payload:ALIAS[low]}; return {kind:"invalid"}; }
    const isTouch = typeof window!=="undefined" && ("ontouchstart" in window || navigator.maxTouchPoints>0 || matchMedia("(pointer:coarse)").matches);

    function Stat({label,value}) {
      return (
        <div className="px-3 py-2 rounded-xl panel text-center">
          <div className="text-[12px] text-purple-200/80">{label}</div>
          <div className="text-lg font-semibold tabular-nums">{value}</div>
        </div>
      );
    }

    function App(){
      // modes & ranges
      const [mode,setMode]=useState("classic");          // classic | survival | timed
      const [includeBC,setIncludeBC]=useState(false);

      // Default ranges: AD = 1..10000, BC = -10000..10000
      const [adRange,setAdRange] = useState({min:1, max:10000});
      const [bcRange,setBcRange] = useState({min:-10000, max:10000});

      // The currently active range mirrors the chosen mode
      const [minY,setMinY]=useState(1);
      const [maxY,setMaxY]=useState(10000);

      // game state
      const [date,setDate]=useState(()=>randomDate(1,10000));
      const correct=useMemo(()=>wday(date.y,date.m,date.d),[date]);
      const [input,setInput]=useState(""), inputRef=useRef(null);
      const [msg,setMsg]=useState(""), [guesses,setGuesses]=useState([]);
      const [flawless,setFlawless]=useState(true);
      const [played,setPlayed]=useState(0), [good,setGood]=useState(0);
      const [streak,setStreak]=useState(0), [best,setBest]=useState(0);
      const [secs,setSecs]=useState(60), [run,setRun]=useState(false);

      // avoid keyboard pop on phones each round
      useEffect(()=>{ if(!isTouch) inputRef.current?.focus(); else document.activeElement?.blur(); },[date]);

      useEffect(()=>{ if(mode!=="timed"||!run||secs<=0) return; const t=setTimeout(()=>setSecs(s=>s-1),1000); return ()=>clearTimeout(t);},[mode,run,secs]);
      useEffect(()=>{ if(mode==="timed"&&secs===0){ setRun(false); setMsg("Time! Session ended."); }},[mode,secs]);

      // Toggle BC remembers its own range values (and AD remembers its own)
      function handleToggleBC(checked){
        setIncludeBC(checked);
        if (checked) { setMinY(bcRange.min); setMaxY(bcRange.max); }
        else { setMinY(Math.max(1, adRange.min)); setMaxY(adRange.max); }
        setDate(randomDate(checked ? bcRange.min : Math.max(1, adRange.min),
                           checked ? bcRange.max : adRange.max));
      }

      // Range updates (sliders & inputs) – keep per-mode memory
      function setMinActive(v){
        if (includeBC) {
          const m = Math.min(v, maxY);
          setBcRange(r=>({...r, min:m}));
          setMinY(m===0? -1 : m);
        } else {
          const m = Math.max(1, Math.min(v, maxY));
          setAdRange(r=>({...r, min:m}));
          setMinY(m);
        }
      }
      function setMaxActive(v){
        if (includeBC) {
          const m = Math.max(v, minY);
          setBcRange(r=>({...r, max:m}));
          setMaxY(m===0? 1 : m);
        } else {
          const m = Math.max(v, minY, 1);
          setAdRange(r=>({...r, max:m}));
          setMaxY(m);
        }
      }

      const resetRound=()=>{ setGuesses([]); setFlawless(true); setInput(""); setDate(randomDate(minY,maxY)); setMsg(""); };
      const summary=()=> `Score: ${good}/${played} (${played?(good/played*100).toFixed(1):"0.0"}%) — Longest: ${best}`;
      const resetStats=()=>{ setPlayed(0); setGood(0); setStreak(0); setBest(0); setMsg("Stats reset."); };

      function submit(txt){
        const {kind,payload}=parseAns(txt);
        if(kind==="cmd"&&payload==="stop"){ setMsg(summary()); setRun(false); return; }
        if(kind==="cmd"&&payload==="help"){ setMsg(`Answer: ${DAY[correct]}.`); setPlayed(p=>p+1); setStreak(0); if(mode==="survival"){ setMsg(m=>m+" Game over."); return; } resetRound(); return; }
        if(kind==="invalid"){ setMsg("Invalid input. Type a day or 0–6. Use 'help' or 'stop'."); return; }
        if(payload===correct){
          if(flawless){
            setMsg("Correct ✔"); setPlayed(p=>p+1); setGood(c=>c+1);
            setStreak(s=>{ const ns=s+1; if(ns>best) setBest(ns); return ns; }); resetRound();
          } else {
            setMsg("Correct — but this round is scored incorrect due to an earlier miss.");
            setPlayed(p=>p+1); setStreak(0);
            if(mode==="survival"){ setMsg(m=>m+" Game over."); return; } resetRound();
          }
        } else {
          setFlawless(false); setMsg("Incorrect ✖");
          const label=DAY[payload]; setGuesses(g=>g.includes(label)?g:[...g,label]);
          if(mode==="survival"){ setPlayed(p=>p+1); setStreak(0); setMsg(m=>`${m} Answer: ${DAY[correct]}. Game over.`); }
        }
      }

      const onClickDay=i=>{ if(mode==="timed"&&!run&&secs>0) setRun(true); submit(String(i)); setInput(""); if(isTouch) document.activeElement?.blur(); };
      const onSubmit=e=>{ e.preventDefault(); if(mode==="timed"&&!run&&secs>0) setRun(true); submit(input); setInput(""); if(!isTouch) inputRef.current?.focus(); };

      return (
        <div className="mx-auto px-4 py-5 w-full max-w-[480px]">
          {/* Header */}
          <div className="flex items-center justify-between gap-2">
            <h1 className="text-xl font-semibold leading-none">Calendar Game</h1>
            <div className="flex items-center gap-2">
              <select value={mode} onChange={e=>{setMode(e.target.value); setMsg(""); setStreak(0); setSecs(60); setRun(false);}}
                className="panel rounded-xl px-2.5 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-purple-400">
                <option value="classic">Classic</option>
                <option value="survival">Survival</option>
                <option value="timed">Timed 60s</option>
              </select>
              <label className="flex items-center gap-2 text-sm">
                <input type="checkbox" className="sr-only" checked={includeBC} onChange={e=>handleToggleBC(e.target.checked)} />
                <span className={`w-10 h-6 rounded-full relative ${includeBC?"bg-purple-500":"bg-zinc-600"}`}>
                  <span className={`absolute top-0.5 left-0.5 w-5 h-5 rounded-full bg-white transition-transform ${includeBC?"translate-x-4":""}`}></span>
                </span>
                <span>BC</span>
              </label>
            </div>
          </div>

          {/* Stats + Reset */}
          <div className="mt-4 grid grid-cols-2 gap-3">
            <Stat label="Score" value={`${good}/${played}`} />
            <Stat label="Accuracy" value={`${played?(good/played*100).toFixed(1):"0.0"}%`} />
            <Stat label="Streak" value={streak} />
            <Stat label="Longest" value={best} />
          </div>
          <div className="mt-2 flex justify-end">
            <button className="text-xs px-3 py-1.5 rounded-lg bg-purple-700 hover:bg-purple-600"
                    onClick={resetStats}>Reset stats</button>
          </div>

          {/* Year range (collapsible) */}
          <details className="mt-3 rounded-2xl card p-3">
            <summary className="cursor-pointer text-sm text-purple-200/90">Year range <span className="tabular-nums ml-1">{minY} → {maxY}</span></summary>
            <div className="mt-3 space-y-3">
              <div className="flex items-center gap-3">
                <input type="range" min={includeBC?-10000:1} max="10000" step="1" value={minY}
                  onChange={e=>setMinActive(+e.target.value)} className="w-full accent-purple-500"/>
                <input type="range" min={includeBC?-10000:1} max="10000" step="1" value={maxY}
                  onChange={e=>setMaxActive(+e.target.value)} className="w-full accent-purple-500"/>
              </div>
              <div className="grid grid-cols-2 gap-3">
                <input type="number" inputMode="numeric" className="panel rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-400"
                  value={minY} onChange={e=>setMinActive(+e.target.value)} />
                <input type="number" inputMode="numeric" className="panel rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-400"
                  value={maxY} onChange={e=>setMaxActive(+e.target.value)} />
              </div>
              <p className="text-xs text-purple-300/70">Proleptic Gregorian calendar. Year 0 isn’t shown (1 BC ↔ year 0 internally). AD and BC remember their own ranges.</p>
            </div>
          </details>

          {/* Prompt */}
          <div className="mt-5 p-4 rounded-3xl card">
            <div className="text-center">
              <div className="text-xs uppercase tracking-widest text-purple-300/70">What day is this?</div>
              <div className="mt-1 text-3xl font-bold">{fmt(date.y,date.m,date.d)}</div>
            </div>

            {/* Day buttons */}
            <div className="mt-4 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-7 gap-2">
              {DAY.map((n,i)=>(
                <button key={n} onClick={()=>onClickDay(i)}
                  className="w-full rounded-xl border border-purple-800/60 bg-purple-900/30 active:bg-purple-900/60 px-3 py-2 text-sm">
                  {n}
                </button>
              ))}
            </div>

            {/* Input row */}
            <form onSubmit={onSubmit} className="mt-3 grid grid-cols-[1fr_auto_auto] gap-2 items-center">
              <input ref={inputRef} value={input} onChange={e=>setInput(e.target.value)}
                placeholder="Type a day (e.g., Monday) or 0–6"
                className="panel rounded-xl px-3 py-2 focus:outline-none focus:ring-2 focus:ring-purple-400" />
              <button className="px-4 py-2 rounded-xl bg-purple-600 text-white text-sm font-medium">Submit</button>
              <button type="button" onClick={()=>submit('help')}
                className="px-4 py-2 rounded-xl border border-purple-700/60 text-sm font-medium bg-purple-900/50">Help</button>
            </form>

            {msg && (
              <div className="mt-3 text-purple-100/90 text-sm">
                <div>{msg}</div>
              </div>
            )}
          </div>

          <div className="mt-3 text-[11px] text-purple-300/60 text-center">Keyboard: Enter=submit, digits 0–6, “help”, “stop”.</div>
        </div>
      );
    }

    try { ReactDOM.createRoot(document.getElementById("root")).render(<App/>); }
    catch (e) { const er=document.getElementById("errors"); er.style.display="block"; er.textContent=String(e?.message||e); }
  </script>
</body>
</html>
