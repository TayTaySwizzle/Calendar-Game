<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="theme-color" content="#140b22">
  <title>Calendar Game</title>
  <meta name="application-name" content="Calendar Game">
  <meta name="apple-mobile-web-app-title" content="Calendar Game">
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{--bg1:#0b0714;--bg2:#140b22}
    body{background:linear-gradient(180deg,var(--bg1),var(--bg2));min-height:100vh}
    .card{background:rgba(26,15,43,.85);border:1px solid rgba(120,53,175,.45)}
    .panel{background:rgba(88,28,135,.25);border:1px solid rgba(120,53,175,.45)}
    .thin{border:1px solid rgba(120,53,175,.35)}
    .btn{border:1px solid rgba(120,53,175,.5);background:rgba(120,53,175,.2)}
    .btn:hover{background:rgba(120,53,175,.35)}
    .flash-good{--ring:rgba(16,185,129,.5);--bg0:rgba(16,185,129,.1);--bg1:rgba(16,185,129,.25);animation:flashPulse .45s ease-in-out}
    .flash-bad{--ring:rgba(239,68,68,.5);--bg0:rgba(239,68,68,.1);--bg1:rgba(239,68,68,.25);animation:flashPulse .45s ease-in-out}
    @keyframes flashPulse{
      0%{box-shadow:0 0 0 0 var(--ring);background:var(--bg0)}
      100%{box-shadow:0 0 0 12px rgba(0,0,0,0);background:var(--bg1)}
    }
    .flipable{transition:transform 450ms ease-in-out;transform-origin:50% 50%}
    .no-anim{transition:none!important}
    .chip{background:rgba(120,53,175,.25);border:1px solid rgba(120,53,175,.45);padding:.25rem .5rem;border-radius:.75rem;font-size:12px}
    .bar{height:6px;border-radius:6px;overflow:hidden;background:rgba(120,53,175,.25);border:1px solid rgba(120,53,175,.45)}
    .bar>span{display:block;height:100%;background:linear-gradient(90deg,#a855f7,#7c3aed)}
    /* Lookup page background (only on lookup) */
    .lookup-bg{
      background-image:url('mandelbrot-purple.png');
      background-size:cover;background-position:center;
    }
    /* Dimming for disabled stats/avg */
    .dimmed{opacity:.45;filter:saturate(.6)}
  </style>
</head>
<body class="text-purple-50">
  <div id="root" class="min-h-screen w-full">Loading…</div>
  <pre id="errors" style="display:none;white-space:pre-wrap;background:#1f0f30;border:1px solid #7034af;padding:.75rem;border-radius:.75rem;margin:1rem;max-width:64rem"></pre>

  <script>
    // in-page error surface for easier debugging
    addEventListener('error', e => {
      const x = document.getElementById('errors');
      x.style.display='block';
      x.textContent = '⚠️ ' + (e.message || 'error');
    });
    addEventListener('unhandledrejection', e => {
      const x = document.getElementById('errors');
      x.style.display='block';
      x.textContent = '⚠️ ' + (e.reason && e.reason.message ? e.reason.message : String(e.reason));
    });
  </script>

  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel" data-presets="env,react">
    const {useEffect,useMemo,useRef,useState} = React;

    /* ---------- Calendar helpers ---------- */
    const MONTH = ["January","February","March","April","May","June","July","August","September","October","November","December"];
    const DAY   = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];
    const DAY_ABBR = ["su","mo","tu","we","th","fr","sa","sun","mon","tue","wed","thu","fri","sat"];

    // map 1 BC -> 0 (astronomical); no year 0 in UI, but math uses it
    const toAstro = y => y>0 ? y : 1 - Math.abs(y);
    const isLeap  = y => { y=toAstro(y); return (y%400===0) || (y%4===0 && y%100!==0); };
    const dim = (y,m)=> m===2 ? (isLeap(y)?29:28) : ([4,6,9,11].includes(m)?30:31);
    function jdnGregorian(y,m,d){
      // Gregorian calendar, valid proleptically for all integer years (astronomical numbering)
      const a = Math.floor((14-m)/12);
      const y2 = y + 4800 - a;
      const m2 = m + 12*a - 3;
      return d + Math.floor((153*m2+2)/5) + 365*y2 + Math.floor(y2/4) - Math.floor(y2/100) + Math.floor(y2/400) - 32045;
    }
    // weekday 0=Sun..6=Sat
    const wday=(y,m,d)=> (jdnGregorian(toAstro(y),m,d)+1)%7;
    const fmtYear = y => y>0?String(y):`${Math.abs(y)} BC`;
    const fmt = (y,m,d)=> `${MONTH[m-1]} ${d}, ${fmtYear(y)}`;
    const rint=(a,b)=>Math.floor(Math.random()*(b-a+1))+a;

    // choose a random date within provided range (inclusive), skipping year 0
    function randomDate(minY,maxY){
      let y;
      while(true){
        y = rint(minY,maxY);
        if(y!==0) break;
      }
      const m = rint(1,12);
      const d = rint(1,dim(y,m));
      return {y,m,d};
    }

    /* ---------- Device detection ---------- */
    function useIsDesktop(){
      const [isDesktop,setIsDesktop]=useState(false);
      useEffect(()=>{
        const update=()=>{
          const hasTouch = (navigator.maxTouchPoints||0) > 0;
          // Treat devices without touch as desktop
          setIsDesktop(!hasTouch);
        };
        update();
        window.addEventListener('resize',update);
        return ()=>window.removeEventListener('resize',update);
      },[]);
      return isDesktop;
    }

    /* ---------- Stats (per mode) ---------- */
    function makeStats(){ return {correct:0,total:0,streak:0,longest:0,avgSum:0,avgCount:0,lastStart:0}; }
    const MODES = ["classic","blitz","sudden","flash","deduction","lookup"];

    /* ---------- Main App ---------- */
    function App(){
      const isDesktop = useIsDesktop();
      const [mode,setMode]=useState("classic");
      const [flip,setFlip]=useState(false);
      const [disableStats,setDisableStats]=useState(false);
      const [disableAvg,setDisableAvg]=useState(true); // Item 7: "Disable ave time" defaults to enabled (red)
      const [avgWasDisabled,setAvgWasDisabled]=useState(true); // track cycles for reset rule
      const [ad,setAd]=useState(true); // AD vs BC
      // separate ranges for AD and BC
      const [rangeAD,setRangeAD]=useState({min:1600,max:2100});
      const [rangeBC,setRangeBC]=useState({min:-500,max:-1});
      // per-mode stats
      const [stats,setStats]=useState(()=>{
        const o={}; MODES.forEach(m=>o[m]=makeStats()); return o;
      });
      // history per mode
      const [history,setHistory]=useState(()=>{
        const o={}; MODES.forEach(m=>o[m]=[]); return o;
      });

      // current date/problem & auxiliary state
      const [cur,setCur]=useState(()=>randomDate(rangeAD.min,rangeAD.max));
      const [reveal,setReveal]=useState(false);
      const [feedback,setFeedback]=useState(null); // 'good' | 'bad' for flash animation
      const [input,setInput]=useState("");

      /* ---------- Timers ---------- */
      const [blitzRunning,setBlitzRunning]=useState(false);
      const [blitzLeft,setBlitzLeft]=useState(30); // seconds
      const blitzRef = useRef(null);

      const [suddenLeft,setSuddenLeft]=useState(5); // seconds per question
      const suddenRef = useRef(null);
      const [suddenRunning,setSuddenRunning]=useState(false);

      const [flashState,setFlashState]=useState("idle"); // idle|running|hidden
      const [flashLeft,setFlashLeft]=useState(1.2); // seconds
      const flashRef = useRef(null);

      const activeRange = ad ? rangeAD : rangeBC;
      const setActiveRange = ad ? setRangeAD : setRangeBC;

      const curWday = useMemo(()=>wday(cur.y,cur.m,cur.d),[cur]);

      // helper to start timing for avg
      function markStart(){
        setStats(s=>{
          const next={...s};
          next[mode] = {...next[mode], lastStart:performance.now()};
          return next;
        });
      }

      // reset avg when disableAvg cycles from true->false per rule
      useEffect(()=>{
        if(avgWasDisabled && !disableAvg){
          // transitioned from disabled -> enabled (tracking resumes) => reset average
          setStats(s=>{
            const next={...s};
            next[mode] = {...next[mode], avgSum:0, avgCount:0};
            return next;
          });
        }
        setAvgWasDisabled(disableAvg);
      },[disableAvg]); // eslint-disable-line

      // change mode resets local UI but keeps per-mode stats intact (Item 3)
      useEffect(()=>{
        setReveal(false);
        setFeedback(null);
        setInput("");
        stopAllTimers();
        if(mode==="blitz"){ setBlitzLeft(30); }
        if(mode==="sudden"){ setSuddenLeft(5); }
        if(mode==="flash"){ setFlashLeft(1.2); setFlashState("idle"); }
      },[mode]);

      function stopAllTimers(){
        if(blitzRef.current){ clearInterval(blitzRef.current); blitzRef.current=null; }
        if(suddenRef.current){ clearInterval(suddenRef.current); suddenRef.current=null; }
        if(flashRef.current){ clearInterval(flashRef.current); flashRef.current=null; }
        setBlitzRunning(false);
        setSuddenRunning(false);
      }

      function nextDate(pushHistory=true){
        if(pushHistory){
          setHistory(h=>{
            const nx={...h};
            nx[mode] = [...nx[mode], cur];
            return nx;
          });
        }
        const r = randomDate(activeRange.min, activeRange.max);
        setCur(r);
        setReveal(false);
        setFeedback(null);
        setInput("");
        if(mode==="sudden"){
          setSuddenLeft(5);
          setSuddenRunning(true);
        }
        if(!disableAvg){
          markStart();
        }
      }

      useEffect(()=>{ // initialize
        nextDate(false);
      },[]);

      /* ---------- Stats helpers ---------- */
      function record(correct){
        if(mode==="lookup") return; // no stats
        setStats(s=>{
          const m = {...s[mode]};
          m.total += 1;
          if(correct){
            m.correct += 1;
            m.streak += 1;
            if(m.streak>m.longest) m.longest=m.streak;
            if(!disableAvg && m.lastStart){
              const dt = (performance.now()-m.lastStart)/1000;
              m.avgSum += dt;
              m.avgCount += 1;
            }
          }else{
            m.streak = 0;
          }
          return {...s, [mode]:m};
        });
      }

      const avgTime = useMemo(()=>{
        const m=stats[mode];
        return m.avgCount>0 ? (m.avgSum/m.avgCount) : 0;
      },[stats,mode]);

      /* ---------- Answer handlers ---------- */
      function submitAnswer(index){
        if(mode==="flash" && flashState!=="hidden") return; // can't answer until hidden
        const ok = index===curWday;
        record(ok);
        setFeedback(ok ? "good" : "bad");
        setReveal(true);
        if(mode==="sudden" && !ok){
          // end run
          setSuddenRunning(false);
          if(suddenRef.current){ clearInterval(suddenRef.current); suddenRef.current=null; }
        }
        if(mode==="blitz" && !blitzRunning){
          // allow answering even when stopped; no special behavior
        }
      }

      // Desktop textbox parsing (0-6 or names/abbr)
      function parseDesktopInput(v){
        const t = v.trim().toLowerCase();
        if(t==="") return null;
        // prefer numbers 0-6
        if(/^[0-6]$/.test(t)) return Number(t);
        // names/abbreviations
        const map={
          "sunday":0,"sun":0,"su":0,
          "monday":1,"mon":1,"mo":1,
          "tuesday":2,"tue":2,"tu":2,
          "wednesday":3,"wed":3,"we":3,
          "thursday":4,"thu":4,"th":4,
          "friday":5,"fri":5,"fr":5,
          "saturday":6,"sat":6,"sa":6
        };
        return (t in map) ? map[t] : null;
      }

      /* ---------- Timers logic ---------- */
      // Blitz session countdown
      useEffect(()=>{
        if(mode!=="blitz") return;
        if(!blitzRunning){ if(blitzRef.current){clearInterval(blitzRef.current);blitzRef.current=null;} return; }
        blitzRef.current = setInterval(()=>{
          setBlitzLeft(x=>{
            if(x<=0.05){ clearInterval(blitzRef.current); blitzRef.current=null; setBlitzRunning(false); return 0; }
            return +(x-0.05).toFixed(2);
          });
        },50);
        return ()=>{ if(blitzRef.current){clearInterval(blitzRef.current);blitzRef.current=null;} };
      },[blitzRunning,mode]);

      // Sudden: per-question timer
      useEffect(()=>{
        if(mode!=="sudden") return;
        if(!suddenRunning){ if(suddenRef.current){clearInterval(suddenRef.current); suddenRef.current=null;} return; }
        suddenRef.current = setInterval(()=>{
          setSuddenLeft(x=>{
            if(x<=0.05){
              clearInterval(suddenRef.current); suddenRef.current=null;
              setSuddenRunning(false);
              setReveal(true);
              record(false); // timeout counts wrong
              return 0;
            }
            return +(x-0.05).toFixed(2);
          });
        },50);
        return ()=>{ if(suddenRef.current){clearInterval(suddenRef.current);suddenRef.current=null;} };
      },[suddenRunning,mode]);

      // Flash: bar counts down entire flash window; auto hide date
      useEffect(()=>{
        if(mode!=="flash") return;
        if(flashState!=="running"){ if(flashRef.current){clearInterval(flashRef.current); flashRef.current=null;} return; }
        flashRef.current = setInterval(()=>{
          setFlashLeft(x=>{
            if(x<=0.05){
              clearInterval(flashRef.current); flashRef.current=null;
              setFlashState("hidden"); // ellipses shown, ready to answer
              return 0;
            }
            return +(x-0.05).toFixed(2);
          });
        },50);
        return ()=>{ if(flashRef.current){clearInterval(flashRef.current);flashRef.current=null;} };
      },[flashState,mode]);

      /* ---------- UI bits ---------- */
      const dateText = fmt(cur.y,cur.m,cur.d);
      const dateStyle = flip ? {transform:'rotate(180deg)'} : undefined; // clockwise net (180 on toggle, then 360 back to reset)
      const flipOff = ()=>{
        // rotate clockwise back to normal
        const el=document.getElementById('dateText');
        if(el){
          el.style.transition='transform 450ms ease-in-out';
          el.style.transform='rotate(360deg)';
          setTimeout(()=>{ el.style.transition=''; el.style.transform=''; },460);
        }
        setFlip(false);
      };

      const stat = stats[mode];
      const scoreStr = `${stat.correct} / ${stat.total}`;
      const streakStr = `${stat.streak} / ${stat.longest}`;

      function resetForRevealBehavior(){
        // Used by Flash "Reveal" -> act like Reset
        setFlashState("idle");
        setFlashLeft(1.2);
      }

      /* ---------- Option builders (Deduction) ---------- */
      const [deductKind,setDeductKind]=useState("year"); // year|month|day
      const [deductOptions,setDeductOptions]=useState([]);
      const [deductAnswer,setDeductAnswer]=useState(null);
      const [deductGuess,setDeductGuess]=useState(null);

      function buildDeductionPuzzle(){
        const {y,m,d} = randomDate(activeRange.min, activeRange.max);
        const wd = wday(y,m,d);
        let opts=[], ans=null, prompt={};
        if(deductKind==="year"){
          // nearest years (same wd for given month/day). Search window ±30y
          const matches=[];
          for(let yy=y-60; yy<=y+60; yy++){
            if(yy===0) continue;
            if(wday(yy,m,d)===wd) matches.push(yy);
          }
          matches.sort((a,b)=>Math.abs(a-y)-Math.abs(b-y));
          const pool = matches.slice(0,8);
          // ensure unique and include actual y
          if(!pool.includes(y)) pool[0]=y;
          opts = pool.sort((a,b)=>a-b);
          ans = y;
          prompt = {y:null,m,d,wd};
          setCur({y,m,d}); // show the base date
        }else if(deductKind==="month"){
          // months of year where this day,year has given wd
          const yy = y;
          const possibilities=[];
          for(let mm=1; mm<=12; mm++){
            if(wday(yy,mm,d)===wd && d<=dim(yy,mm)) possibilities.push(mm);
          }
          while(possibilities.length<6){
            const mm=rint(1,12);
            if(!possibilities.includes(mm) && d<=dim(yy,mm)) possibilities.push(mm);
          }
          opts = possibilities.slice(0,8).sort((a,b)=>a-b);
          ans = m;
          prompt = {y:yy,m:null,d,wd};
          setCur({y:yy,m,d});
        }else{
          // day number in month where this y,m has given wd
          const yy=y, mm=m;
          const days=[];
          const L=dim(yy,mm);
          for(let dd=1; dd<=L; dd++){
            if(wday(yy,mm,dd)===wd) days.push(dd);
          }
          while(days.length<6){
            const dd=rint(1,L);
            if(!days.includes(dd)) days.push(dd);
          }
          opts = days.slice(0,10).sort((a,b)=>a-b);
          ans = d;
          prompt = {y:yy,m:mm,d:null,wd};
          setCur({y:yy,m:mm,d});
        }
        setDeductOptions(opts);
        setDeductAnswer(ans);
        setDeductGuess(null);
      }

      useEffect(()=>{
        if(mode==="deduction"){ buildDeductionPuzzle(); }
      },[mode,deductKind,ad]);

      /* ---------- Render helpers ---------- */
      function ModeTabs(){
        const tabs=["classic","blitz","sudden","flash","deduction","lookup"];
        return (
          <div className="flex flex-wrap gap-2 justify-center">
            {tabs.map(t=>(
              <button key={t}
                onClick={()=>setMode(t)}
                className={"px-3 py-1 rounded-full chip "+(mode===t?"ring-2 ring-purple-400":"")}>
                {t[0].toUpperCase()+t.slice(1)}
              </button>
            ))}
          </div>
        );
      }

      function YearControls(){
        const R = activeRange;
        const setR = (k,v)=>setActiveRange(x=>({...x,[k]:v}));
        return (
          <div className="mt-4 grid grid-cols-1 sm:grid-cols-2 gap-3">
            <div className="panel rounded-xl p-3">
              <div className="flex items-center gap-3">
                <label className="chip">Min Year</label>
                <input type="number" className="bg-transparent border border-purple-700/40 rounded px-2 py-1 w-32"
                  value={R.min} onChange={e=>setR("min",Math.max(-10000,Math.min(10000,Number(e.target.value)||0)))} />
              </div>
              <input type="range" min="-10000" max="10000" step="1" value={R.min}
                onChange={e=>setR("min",Number(e.target.value))} className="w-full mt-2"/>
            </div>
            <div className="panel rounded-xl p-3">
              <div className="flex items-center gap-3">
                <label className="chip">Max Year</label>
                <input type="number" className="bg-transparent border border-purple-700/40 rounded px-2 py-1 w-32"
                  value={R.max} onChange={e=>setR("max",Math.max(-10000,Math.min(10000,Number(e.target.value)||0)))} />
              </div>
              <input type="range" min="-10000" max="10000" step="1" value={R.max}
                onChange={e=>setR("max",Number(e.target.value))} className="w-full mt-2"/>
            </div>
            <div className="flex items-center gap-3 justify-center sm:justify-start">
              <label className="chip">Era</label>
              <div className="flex items-center gap-2">
                <button onClick={()=>setAd(true)} className={"btn px-3 py-1 rounded "+(ad?"ring-2 ring-purple-400":"")}>AD</button>
                <button onClick={()=>setAd(false)} className={"btn px-3 py-1 rounded "+(!ad?"ring-2 ring-purple-400":"")}>BC</button>
              </div>
            </div>
          </div>
        );
      }

      function StatsRow(){
        const S = stats[mode];
        return (
          <div className="grid grid-cols-1 sm:grid-cols-3 gap-3 mt-4">
            <div className={"panel rounded-xl p-3 "+(disableStats?"dimmed":"")}>
              <div className="text-xs text-purple-200/80 mb-1">Score</div>
              <div className="text-2xl font-semibold">{scoreStr}</div>
            </div>
            <div className={"panel rounded-xl p-3 "+(disableStats?"dimmed":"")}>
              <div className="text-xs text-purple-200/80 mb-1">Streak / Longest</div>
              <div className="text-2xl font-semibold">{streakStr}</div>
            </div>
            <div className={"panel rounded-xl p-3 "+(disableAvg?"dimmed":"")}>
              <div className="flex items-center justify-between">
                <div className="text-xs text-purple-200/80 mb-1">Average Time</div>
              </div>
              <div className="text-2xl font-semibold">{S.avgCount>0 ? avgTime.toFixed(2)+' s' : '—'}</div>
            </div>
          </div>
        );
      }

      function TogglesRow(){
        return (
          <div className="grid grid-cols-1 sm:grid-cols-3 gap-3 mt-4">
            <label className={"panel rounded-xl p-3 flex items-center justify-between cursor-pointer " + (disableStats?"ring-2 ring-red-500/60": "")}>
              <span>Disable stats</span>
              <input type="checkbox" className="accent-fuchsia-400 h-5 w-5" checked={disableStats}
                onChange={e=>setDisableStats(e.target.checked)} />
            </label>
            <label className={"panel rounded-xl p-3 flex items-center justify-between cursor-pointer " + (disableAvg?"ring-2 ring-red-500/60": "")}>
              <span>Disable ave time</span>
              <input type="checkbox" className="accent-fuchsia-400 h-5 w-5" checked={disableAvg}
                onChange={e=>setDisableAvg(e.target.checked)} />
            </label>
            <label className="panel rounded-xl p-3 flex items-center justify-between cursor-pointer">
              <span>Flip date</span>
              <input type="checkbox" className="accent-fuchsia-400 h-5 w-5" checked={flip}
                onChange={e=>{
                  if(e.target.checked){ setFlip(true); }
                  else{ flipOff(); }
                }} />
            </label>
          </div>
        );
      }

      function DayButtons({onPick}){
        return (
          <div className="mt-4 grid grid-cols-2 xs:grid-cols-3 sm:grid-cols-4 lg:grid-cols-7 gap-2">
            {DAY.map((d,i)=>(
              <button key={i} onClick={()=>onPick(i)}
                className={"btn rounded-xl py-3 font-medium "+(feedback && (i===curWday)?"ring-2 ring-green-400":"")} >
                {d}
              </button>
            ))}
          </div>
        );
      }

      function DesktopInput({onSubmit}){
        if(!isDesktop) return null;
        return (
          <div className="mt-3 hidden sm:flex items-center gap-2">
            <input value={input} onChange={e=>setInput(e.target.value)}
              onKeyDown={e=>{ if(e.key==="Enter"){ const idx=parseDesktopInput(input); if(idx!==null){ onSubmit(idx); setInput(""); } } }}
              className="flex-1 bg-transparent border border-purple-700/40 rounded px-3 py-2"
              placeholder="Type 0–6 or Sunday…Saturday (Sun/Mon/Tue/etc), then Enter" />
            <button className="btn rounded px-3 py-2" onClick={()=>{ const idx=parseDesktopInput(input); if(idx!==null){ onSubmit(idx); setInput(""); }}}>Submit</button>
          </div>
        );
      }

      function ControlsRow(){
        // center & widen; Begin wider
        const base="btn rounded-xl px-4 py-2 min-w-[7.5rem]";
        return (
          <div className="mt-5 flex flex-wrap items-center justify-center gap-2">
            {mode!=="lookup" && <button className={base} onClick={()=>nextDate(true)}>New</button>}
            {mode!=="lookup" && <button className={base} onClick={()=>setReveal(true)}>Reveal</button>}
            {history[mode].length>0 && mode!=="lookup" && <button className={base} onClick={()=>{
              setCur(history[mode][history[mode].length-1]);
              setHistory(h=>({...h,[mode]:h[mode].slice(0,-1)}));
              setReveal(true);
            }}>Back</button>}

            {/* Mode-specific controls */}
            {mode==="blitz" && (
              <>
                <button className={base+" font-semibold min-w-[9.5rem]"} onClick={()=>{ setBlitzRunning(s=>!s); if(!blitzRunning){ if(!disableAvg) markStart(); } }}>{blitzRunning?"Stop":"Begin"}</button>
                <button className={base} onClick={()=>{ setBlitzRunning(false); setBlitzLeft(30); }}>Reset</button>
              </>
            )}
            {mode==="sudden" && (
              <>
                <button className={base+" font-semibold min-w-[9.5rem]"} onClick={()=>{ setSuddenRunning(true); setSuddenLeft(5); nextDate(false); if(!disableAvg) markStart(); }}>Begin</button>
                <button className={base} onClick={()=>{ setSuddenRunning(false); setSuddenLeft(5); }}>Reset</button>
              </>
            )}
            {mode==="flash" && (
              <>
                <button className={base+" font-semibold min-w-[9.5rem]"} onClick={()=>{ setFlashState("running"); setFlashLeft(1.2); if(!disableAvg) markStart(); }}>Begin</button>
                <button className={base} onClick={()=>{ resetForRevealBehavior(); }}>Reset</button>
              </>
            )}
            {mode==="lookup" && (
              <>
                <button className={base+" font-semibold min-w-[9.5rem]"} onClick={()=>setLookupResult(null)}>Clear</button>
              </>
            )}
          </div>
        );
      }

      /* ---------- Blitz & Sudden & Flash bars ---------- */
      function Bar({value,max}){
        const pct=Math.max(0,Math.min(100,100*value/max));
        return (
          <div className="bar"><span style={{width:pct+'%'}}/></div>
        );
      }

      /* ---------- Lookup ---------- */
      const [lookup,setLookup]=useState({y:2025,m:10,d:8});
      const [lookupResult,setLookupResult]=useState(null);
      function lookupSubmit(){
        const {y,m,d}=lookup;
        if(y===0) return setLookupResult("Year 0 doesn't exist; use 1 BC for 0.");
        if(m<1||m>12) return setLookupResult("Invalid month.");
        if(d<1||d>dim(y,m)) return setLookupResult("Invalid day for that month.");
        setLookupResult(DAY[wday(y,m,d)]);
      }

      /* ---------- Main render ---------- */
      return (
        <div className={"px-4 py-8 "+(mode==="lookup"?"lookup-bg":"")}>
          <div className={"mx-auto w-full "+(mode==="lookup"?"max-w-5xl":"max-w-4xl")}>
            {/* Header */}
            <div className="flex items-center justify-between gap-3">
              <h1 className="text-2xl font-semibold">Calendar Game</h1>
              <ModeTabs/>
            </div>

            {/* Main card */}
            <div className={"mt-5 p-5 rounded-3xl "+(mode==="lookup"?"thin":"card")}>
              {/* Bars */}
              {mode==="blitz" && (
                <div className="mb-3">
                  <div className="flex items-center justify-between text-xs text-purple-200/80 mb-1"><span>Session</span><span>{blitzLeft.toFixed(2)}s</span></div>
                  <Bar value={blitzLeft} max={30}/>
                </div>
              )}
              {mode==="sudden" && (
                <div className="mb-3">
                  <div className="flex items-center justify-between text-xs text-purple-200/80 mb-1"><span>Per‑question</span><span>{suddenLeft.toFixed(2)}s</span></div>
                  <Bar value={suddenLeft} max={5}/>
                </div>
              )}
              {mode==="flash" && (
                <div className="mb-3">
                  <div className="flex items-center justify-between text-xs text-purple-200/80 mb-1"><span>Flash</span><span>{flashLeft.toFixed(2)}s</span></div>
                  <Bar value={flashLeft} max={1.2}/>
                </div>
              )}

              {/* Date */}
              {mode!=="lookup" && (
                <div className={"mt-1 text-center "+(feedback==="good"?"flash-good":feedback==="bad"?"flash-bad":"")}>
                  <div id="dateText" className={"flipable text-3xl sm:text-4xl font-semibold"} style={dateStyle}>
                    {mode==="flash" ? (flashState==="hidden" ? "…" : (flashState==="running" ? fmt(cur.y,cur.m,cur.d) : "—")) : fmt(cur.y,cur.m,cur.d)}
                  </div>
                  {reveal && <div className="mt-1 text-sm">Answer: <span className="font-semibold">{DAY[curWday]}</span></div>}
                </div>
              )}

              {/* Controls row */}
              {mode!=="lookup" && <ControlsRow/>}

              {/* Inputs/Options */}
              {mode==="classic" && (
                <div>
                  <DayButtons onPick={submitAnswer}/>
                  <DesktopInput onSubmit={submitAnswer}/>
                </div>
              )}

              {mode==="blitz" && (
                <div>
                  <DayButtons onPick={submitAnswer}/>
                  <DesktopInput onSubmit={submitAnswer}/>
                </div>
              )}

              {mode==="sudden" && (
                <div>
                  <DayButtons onPick={submitAnswer}/>
                  <DesktopInput onSubmit={submitAnswer}/>
                </div>
              )}

              {mode==="flash" && (
                <div>
                  <DayButtons onPick={submitAnswer}/>
                  <DesktopInput onSubmit={submitAnswer}/>
                  <div className="mt-3 text-sm text-purple-200/80 text-center">In Flash, “Reveal” behaves like Reset.</div>
                </div>
              )}

              {mode==="deduction" && (
                <div>
                  <div className="flex flex-wrap items-center justify-center gap-2 mt-2">
                    <label className={"chip cursor-pointer "+(deductKind==="year"?"ring-2 ring-purple-400":"")} onClick={()=>setDeductKind("year")}>Year</label>
                    <label className={"chip cursor-pointer "+(deductKind==="month"?"ring-2 ring-purple-400":"")} onClick={()=>setDeductKind("month")}>Month</label>
                    <label className={"chip cursor-pointer "+(deductKind==="day"?"ring-2 ring-purple-400":"")} onClick={()=>setDeductKind("day")}>Day</label>
                    <button className="btn rounded-xl px-3 py-1" onClick={()=>buildDeductionPuzzle()}>New puzzle</button>
                  </div>
                  <div className="mt-4 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2">
                    {deductOptions.map((v,i)=>{
                      const correct = v===deductAnswer;
                      const picked = deductGuess===v;
                      const cls = picked ? (correct ? "ring-2 ring-green-400" : "ring-2 ring-red-400") : "";
                      const label = deductKind==="month" ? MONTH[v-1] : String(v>0?v:Math.abs(v)+" BC");
                      return (
                        <button key={i} className={"btn rounded-xl py-3 "+cls}
                          onClick={()=>{ setDeductGuess(v); const ok=(v===deductAnswer); record(ok); setReveal(true); }}>
                          {label}
                        </button>
                      );
                    })}
                  </div>
                </div>
              )}

              {mode==="lookup" && (
                <div className="grid md:grid-cols-2 gap-4">
                  <div className="card rounded-2xl p-4">
                    <div className="text-sm text-purple-200/80 mb-2">Lookup</div>
                    <div className="grid grid-cols-3 gap-2">
                      <div><div className="text-xs">Year</div><input type="number" value={lookup.y} onChange={e=>setLookup(v=>({...v,y:Math.max(-10000,Math.min(10000,Number(e.target.value)||0))}))} className="w-full bg-transparent border border-purple-700/40 rounded px-2 py-2"/></div>
                      <div><div className="text-xs">Month</div><input type="number" value={lookup.m} onChange={e=>setLookup(v=>({...v,m:Number(e.target.value)||1}))} className="w-full bg-transparent border border-purple-700/40 rounded px-2 py-2"/></div>
                      <div><div className="text-xs">Day</div><input type="number" value={lookup.d} onChange={e=>setLookup(v=>({...v,d:Number(e.target.value)||1}))} className="w-full bg-transparent border border-purple-700/40 rounded px-2 py-2"/></div>
                    </div>
                    <div className="mt-3 flex gap-2">
                      <button className="btn rounded px-3 py-2" onClick={lookupSubmit}>Compute</button>
                      <button className="btn rounded px-3 py-2" onClick={()=>setLookup({y:2025,m:10,d:8})}>Today</button>
                    </div>
                    {lookupResult && <div className="mt-3 text-lg">Result: <span className="font-semibold">{lookupResult}</span></div>}
                  </div>
                  <div className="rounded-2xl p-4 panel">
                    <div className="text-sm text-purple-200/80 mb-2">Notes</div>
                    <p className="text-sm text-purple-100/90">Proleptic Gregorian calendar; astronomical year numbering in math (1&nbsp;BC → 0). Year 0 is invalid in input.</p>
                  </div>
                </div>
              )}

              {/* Stats & Toggles */}
              {mode!=="lookup" && <StatsRow/>}
              {mode!=="lookup" && <TogglesRow/>}
              {mode!=="lookup" && <YearControls/>}
            </div>
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App/>);
  </script>
</body>
</html>
