<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<meta name="theme-color" content="#140b22">
<title>Calendar Game</title>
<meta name="application-name" content="Calendar Game">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="Calendar Game">
<link rel="apple-touch-icon" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAEAAAABACAYAAACqaXHeAAAAFklEQVR4nO3BMQEAAADCoPVPbQhPoAAAAAAAAEwD1wAAAf1tU0sAAAAASUVORK5CYII="/>
<style>
:root{--bg1:#0b0714;--bg2:#140b22;--panel:rgba(26,15,43,.85);--border:rgba(120,53,175,.45);--muted:rgba(120,53,175,.35);--chip:rgba(120,53,175,.25);--accent1:#a855f7;--accent2:#7c3aed;}
html,body{height:100%;}
body{margin:0;color:#f5f3ff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:linear-gradient(180deg,var(--bg1),var(--bg2));overflow:hidden;}
#app{min-height:100dvh;display:flex;flex-direction:column;align-items:center;justify-content:flex-start;padding:8px 10px;gap:10px;}
.card{background:var(--panel);border:1px solid var(--border);border-radius:14px;padding:10px;}
.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
h1{font-size:18px;margin:0 0 4px 0;font-weight:700;}
select,button,input{font-size:16px;color:#f5f3ff;background:#1d1430;border:1px solid var(--border);border-radius:10px;padding:8px 10px;outline:0;-webkit-tap-highlight-color:transparent}
button:active{transform:scale(.98)}
.small{font-size:12px;opacity:.9}
.stats{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;width:100%}
.stat{background:rgba(88,28,135,.25);border:1px solid var(--border);border-radius:12px;padding:8px}
.stat .label{font-size:11px;opacity:.85}
.stat .val{font-weight:700}
.dim{opacity:.4;filter:saturate(.7)}
.grid-7{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
.wbtn{padding:8px 0;border-radius:10px;border:1px solid var(--border);background:#281a48;text-align:center;font-weight:700}
.good{outline:2px solid rgba(16,185,129,.6)}
.bad{outline:2px solid rgba(239,68,68,.6)}
.bar{height:6px;border-radius:6px;overflow:hidden;background:rgba(120,53,175,.25);border:1px solid var(--border)}
.bar>span{display:block;height:100%;background:linear-gradient(90deg,var(--accent1),var(--accent2))}
.chip{background:var(--chip);border:1px solid var(--border);padding:.25rem .5rem;border-radius:.75rem;font-size:12px}
.details{max-height:38dvh;overflow:auto}
hr{border:none;border-top:1px solid var(--muted);margin:8px 0}
.hidden{display:none}
.center{display:flex;justify-content:center;align-items:center}
</style>
</head>
<body>
<div id="app">
  <div class="row" style="width:100%;justify-content:space-between">
    <h1>Calendar Game</h1>
    <select id="mode">
      <option value="classic">Classic</option>
      <option value="deduction">Deduction</option>
      <option value="blitz">Blitz</option>
      <option value="sudden">Sudden</option>
      <option value="flash">Flash</option>
      <option value="lookup">Lookup</option>
    </select>
  </div>

  <!-- Stats -->
  <div id="stats" class="stats">
    <div class="stat"><div class="label">Played</div><div class="val" id="played">0</div></div>
    <div class="stat"><div class="label">Correct</div><div class="val" id="correct">0</div></div>
    <div class="stat"><div class="label">Streak</div><div class="val" id="streak">0</div></div>
    <div class="stat"><div class="label">Best</div><div class="val" id="best">0</div></div>
    <div class="stat" id="avgTile"><div class="label">Avg time (correct)</div><div class="val" id="avg">—</div></div>
  </div>

  <!-- Controls -->
  <div class="card" style="width:100%">
    <div class="row" style="justify-content:space-between">
      <label><input id="bc" type="checkbox"/> Include BC</label>
      <span id="modeChips" class="row small"></span>
    </div>
    <hr/>
    <details id="yrDetails">
      <summary>Year range</summary>
      <div class="row details">
        <div>
          <div class="small">AD min</div>
          <input type="number" id="adMin" value="1" min="1" max="10000" style="width:120px">
        </div>
        <div>
          <div class="small">AD max</div>
          <input type="number" id="adMax" value="10000" min="1" max="10000" style="width:120px">
        </div>
        <div id="bcInputs" class="hidden">
          <div>
            <div class="small">BC min</div>
            <input type="number" id="bcMin" value="-10000" min="-10000" max="-1" style="width:120px">
          </div>
          <div>
            <div class="small">BC max</div>
            <input type="number" id="bcMax" value="10000" min="1" max="10000" style="width:120px">
          </div>
        </div>
      </div>
      <div class="small" id="rangeHelp">Use -1 for 1 BC (years allowed -10000…10000).</div>
    </details>
    <hr/>
    <div class="row" id="toggles">
      <label><input id="trackClassic" type="checkbox"/> Track avg (Classic)</label>
      <label><input id="trackDed" type="checkbox"/> Track avg (Deduction)</label>
      <label><input id="statsOff" type="checkbox"/> Disable stats</label>
    </div>
  </div>

  <!-- Game area -->
  <div id="game" class="card" style="width:100%"></div>

  <!-- Message -->
  <div id="msg" class="small"></div>
</div>

<script>
/* ===== Utilities: calendar engine ===== */
const MONTH = ["January","February","March","April","May","June","July","August","September","October","November","December"];
const DAY = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];
const toAstro = y => y>0 ? y : 1-Math.abs(y); // 1 BC -> 0
const isLeap = y => { y = toAstro(y); return y%400===0 || (y%4===0 && y%100!==0); };
const dim = (y,m)=> m===2 ? (isLeap(y)?29:28) : [4,6,9,11].includes(m)?30:31;
function jdnGregorian(y,m,d){
  const a=Math.floor((14-m)/12);
  const y2=y+4800-a;
  const m2=m+12*a-3;
  return d + Math.floor((153*m2+2)/5) + 365*y2 + Math.floor(y2/4) - Math.floor(y2/100) + Math.floor(y2/400) - 32045;
}
const wday=(y,m,d)=> (jdnGregorian(toAstro(y),m,d)+1)%7; // 0=Sun
const fmtYear = y => y>0?String(y):`${Math.abs(y)} BC`;
const fmt=(y,m,d)=> `${MONTH[m-1]} ${d}, ${fmtYear(y)}`;
const rint=(a,b)=>Math.floor(Math.random()*(b-a+1))+a;
function randomDate(range){
  for(;;){
    let y = rint(range.min, range.max);
    if(y===0) continue;
    let m=rint(1,12), d=rint(1,dim(y,m));
    if(d<=dim(y,m)) return {y,m,d};
  }
}

/* ===== State ===== */
const S = {
  mode: "classic",
  adMin:1, adMax:10000,
  bc:false, bcMin:-10000, bcMax:10000,
  statsOff:false,
  trackClassic:false, trackDed:false,
  date: {y:2024,m:1,d:1},
  played:0, good:0, streak:0, best:0,
  tStart:0, timeSum:0, timeCnt:0,
  blitz: {limit:60, remain:60, running:false, started:0, pausedAcc:0},
  sudden: {q:7, remain:7, active:false, deadline:0, pausedAcc:0}
};

function currentRange(){
  if(S.bc) return {min:S.bcMin, max:Math.max(S.adMax,S.bcMax)};
  return {min:S.adMin, max:S.adMax};
}

/* ===== DOM helpers ===== */
const $ = sel => document.querySelector(sel);
const game = $("#game"), msg = $("#msg");
function setMsg(t){ msg.textContent=t||""; }

/* ===== Stats ===== */
function resetAvgIfNeeded(){
  const track = (S.mode==="classic"&&S.trackClassic) || (S.mode==="deduction"&&S.trackDed) || (S.mode==="blitz"||S.mode==="sudden"||S.mode==="flash");
  const disabled = S.statsOff || !track;
  $("#avgTile").classList.toggle("dim", disabled);
  $("#avg").textContent = disabled || S.timeCnt===0 ? "—" : (S.timeSum/S.timeCnt).toFixed(2)+"s";
}
function incPlayed(){ if(!S.statsOff){ S.played++; $("#played").textContent=S.played; } }
function incGood(){ if(!S.statsOff){ S.good++; $("#correct").textContent=S.good; S.streak++; S.best=Math.max(S.best,S.streak); $("#streak").textContent=S.streak; $("#best").textContent=S.best; } }
function wrong(){ if(!S.statsOff){ S.played++; $("#played").textContent=S.played; S.streak=0; $("#streak").textContent=0; } }
function startTimer(){ S.tStart = performance.now(); }
function stopTimer(correct){
  if(S.tStart===0) return;
  const dt=(performance.now()-S.tStart)/1000;
  S.tStart=0;
  const track = (S.mode==="classic"&&S.trackClassic) || (S.mode==="deduction"&&S.trackDed) || (S.mode!=="classic"&&S.mode!=="deduction");
  if(!S.statsOff && track && correct){
    S.timeSum+=dt; S.timeCnt++; 
  }
  resetAvgIfNeeded();
}

/* ===== Rendering ===== */
function renderChips(){
  const c=$("#modeChips");
  c.innerHTML="";
  if(S.mode==="blitz"){
    const r=document.createElement("span"); r.className="chip"; r.textContent=`${S.blitz.limit}s limit`; c.appendChild(r);
    const t=document.createElement("span"); t.className="chip"; t.innerHTML=`Time left <strong id="blitzRemain">${S.blitz.remain}s</strong>`; c.appendChild(t);
    const bar=document.createElement("div"); bar.className="bar"; bar.innerHTML=`<span id="blitzBar" style="width:${(S.blitz.remain/S.blitz.limit)*100}%"></span>`; c.appendChild(bar);
  }else if(S.mode==="sudden"){
    const t=document.createElement("span"); t.className="chip"; t.innerHTML=`Per question <strong>${S.sudden.q}s</strong>`; c.appendChild(t);
    const r=document.createElement("span"); r.className="chip"; r.innerHTML=`Time left <strong id="qRemain">${S.sudden.remain}s</strong>`; c.appendChild(r);
    const bar=document.createElement("div"); bar.className="bar"; bar.innerHTML=`<span id="qBar" style="width:${(S.sudden.remain/S.sudden.q)*100}%"></span>`; c.appendChild(bar);
  }
}

function renderGame(){
  game.innerHTML="";
  const d=S.date;
  if(S.mode==="lookup"){
    const c=document.createElement("div");
    c.innerHTML=`
      <div class="row"><input id="inY" type="text" placeholder="Year (use -1 for 1 BC)" style="flex:1">
      <input id="inM" type="number" min="1" max="12" placeholder="M" style="width:90px">
      <input id="inD" type="number" min="1" max="31" placeholder="D" style="width:90px"></div>
      <div class="small">Use -1 for 1 BC. Minus sign is a normal ASCII hyphen (-). Unicode minus (−) will be accepted and normalized.</div>
      <div class="row" style="justify-content:flex-end;margin-top:6px"><button id="look">Lookup</button></div>
      <div id="lookAns" style="margin-top:6px" class="chip"></div>`;
    game.appendChild(c);
    $("#look").onclick=()=>{
      const ytxt=$("#inY").value.replace(/\u2212/g,"-").trim();
      const y=parseInt(ytxt,10), m=parseInt($("#inM").value,10), d=parseInt($("#inD").value,10);
      if(!y||!m||!d||m<1||m>12||d<1||d>31||d>dim(y,m)){ setMsg("Invalid date."); return; }
      const wd=DAY[wday(y,m,d)];
      $("#lookAns").textContent = `${MONTH[m-1]} ${d}, ${fmtYear(y)} is ${wd}.`;
      setMsg("");
    };
    return;
  }

  const head=document.createElement("div");
  head.className="row";
  head.style.justifyContent="space-between";
  head.innerHTML=`<div><div class="small">Date</div><div style="font-size:18px;font-weight:700">${fmt(d.y,d.m,d.d)}</div></div>
                  <div><button id="newBtn">New</button></div>`;
  game.appendChild(head);
  $("#newBtn").onclick=()=>{ newPuzzle(); };

  if(S.mode==="classic"||S.mode==="blitz"||S.mode==="sudden"||S.mode==="flash"){
    const grid=document.createElement("div");
    grid.className="grid-7";
    DAY.forEach((name,idx)=>{
      const b=document.createElement("button");
      b.className="wbtn"; b.textContent=name.slice(0,3);
      b.onclick=()=>{
        const ok = wday(d.y,d.m,d.d)===idx;
        if(ok){ incGood(); setMsg("Correct!"); } else { wrong(); setMsg("Answer: "+DAY[wday(d.y,d.m,d.d)]); }
        stopTimer(ok);
        if(S.mode==="blitz" && S.blitz.running){ /* continue */ }
        if(S.mode==="flash"){ setTimeout(newPuzzle,250); } else { newPuzzle(); }
      };
      grid.appendChild(b);
    });
    game.appendChild(grid);
    if(S.mode==="blitz"){
      const r=document.createElement("div"); r.className="row center"; r.style.marginTop="6px";
      r.innerHTML=`<button id="begin">Begin</button><button id="end">End</button>`;
      game.appendChild(r);
      $("#begin").onclick=()=>startBlitz();
      $("#end").onclick=()=>endBlitz();
    }
  }

  if(S.mode==="deduction"){
    const row=document.createElement("div"); row.className="row"; row.style.marginTop="6px";
    ["Year","Month","Day"].forEach(type=>{
      const b=document.createElement("button"); b.textContent=type; b.className="wbtn"; b.style.width="100px";
      b.onclick=()=>dedGuess(type.toLowerCase());
      row.appendChild(b);
    });
    game.appendChild(row);
  }
}

function newPuzzle(){
  S.date = randomDate(currentRange());
  renderChips();
  renderGame();
  setMsg("New.");
  startTimer();
}

/* ===== Deduction (simple): choose which field equals a given value ===== */
function dedGuess(type){
  const d=S.date;
  let asked, ans;
  if(type==="year"){ asked=d.y; ans=fmtYear(d.y); }
  if(type==="month"){ asked=d.m; ans=MONTH[d.m-1]; }
  if(type==="day"){ asked=d.d; ans=String(d.d); }
  const ok=true; // choosing a field just reveals; treat as practice
  incGood(); stopTimer(ok); setMsg(`${type[0].toUpperCase()+type.slice(1)}: ${ans}.`);
  newPuzzle();
}

/* ===== Blitz & Sudden timers (no idle RAF) ===== */
let tickTimer=null;
function clearTick(){ if(tickTimer){ clearInterval(tickTimer); tickTimer=null; } }

function startBlitz(){
  if(S.blitz.running) return;
  S.blitz.running=true;
  S.blitz.remain=S.blitz.limit;
  renderChips();
  startTimer();
  clearTick();
  tickTimer=setInterval(()=>{
    if(!S.blitz.running) return;
    S.blitz.remain--;
    const pct=Math.max(0,(S.blitz.remain/S.blitz.limit)*100);
    const r=$("#blitzRemain"), b=$("#blitzBar");
    if(r) r.textContent=S.blitz.remain+"s";
    if(b) b.style.width=pct+"%";
    if(S.blitz.remain<=0){ endBlitz(); }
  },1000);
}
function endBlitz(){
  S.blitz.running=false;
  clearTick();
  setMsg("Blitz complete.");
}

function startSudden(){
  S.sudden.active=true; S.sudden.remain=S.sudden.q;
  renderChips(); startTimer();
  clearTick();
  tickTimer=setInterval(()=>{
    if(!S.sudden.active) return;
    S.sudden.remain--;
    const r=$("#qRemain"), b=$("#qBar");
    if(r) r.textContent=S.sudden.remain+"s";
    if(b) b.style.width=Math.max(0,(S.sudden.remain/S.sudden.q)*100)+"%";
    if(S.sudden.remain<=0){ wrong(); setMsg("Time!"); S.sudden.active=false; clearTick(); newPuzzle(); }
  },1000);
}

/* ===== Wiring ===== */
$("#mode").onchange=e=>{
  S.mode=e.target.value;
  if(S.mode==="blitz"){ S.blitz.remain=S.blitz.limit; }
  if(S.mode==="sudden"){ S.sudden.remain=S.sudden.q; startSudden(); }
  resetAvgIfNeeded();
  newPuzzle();
};
$("#bc").onchange=e=>{
  S.bc=e.target.checked;
  $("#bcInputs").classList.toggle("hidden",!S.bc);
  newPuzzle();
};
$("#adMin").oninput=e=>{ S.adMin=Math.max(1,parseInt(e.target.value||"1",10)); };
$("#adMax").oninput=e=>{ S.adMax=Math.max(S.adMin,parseInt(e.target.value||"10000",10)); };
$("#bcMin").oninput=e=>{ S.bcMin=Math.min(-1,parseInt(e.target.value||"-10000",10)); };
$("#bcMax").oninput=e=>{ S.bcMax=Math.max(1,parseInt(e.target.value||"10000",10)); };
$("#statsOff").onchange=e=>{ S.statsOff=e.target.checked; resetAvgIfNeeded(); };
$("#trackClassic").onchange=e=>{ S.trackClassic=e.target.checked; resetAvgIfNeeded(); };
$("#trackDed").onchange=e=>{ S.trackDed=e.target.checked; resetAvgIfNeeded(); };

/* Initialize */
resetAvgIfNeeded();
S.date = randomDate(currentRange());
renderChips();
renderGame();
startTimer();
</script>
</body>
</html>
